# snapraid-daily
A simple Bash Script for the automation of all essential SnapRAID functions with
in-built email notifications and monitoring of the number of deletions/moves.

# Introduction 
Thank you for your interest in this script! Snapraid is very good software,
but lacks any default automation or notification ability.

That is where this script comes in, it is intended to be an all-in-one
script for the automation of snapraid.

There are other scripts out there that essentially do the same thing. However, none
of them had exactly had the features the author wanted.

This led to this script being created by the author. It has worked extremely well
for the author for many years up to this date, and hopefully prove useful to others,
hence the reason for publishing it here in Github.

The broad goal here is to be an all-in-one script to automate the necessary
snapraid functions that can be scheduled accordingly and do it in a simple manner.

# Table of Contents

- [Scope](#scope)
- [Description](#description)
- [Usage](#usage)
  * [Examples](#examples)
- [Installation and Setup](#installation-and-setup)
  * [Config File Setup](#config-file-setup)
  * [Config File Contents](#config-file-contents)
  * [Sample Config File](#sample-config-file)
  * [Setting Up Email Notifications](#setting-up-email-notifications)
  * [Automation with Systemd](#automation-with-systemd)
  * [Running as a Non-Root User with Systemd](#running-as-a-standard-user-with-systemd)
- [SnapRAID Sync and Scrub Options](#snapraid-sync-and-scrub-options)
- [Detailed Operation](#detailed-operation)
  * [Step 1 - Initial Checks](#step-1---initial-checks)
  * [Step 2 - Check SnapRAID Array Current Status](#step-2---check-snapraid-array-current-status)
  * [Step 3 - Run Touch if Required](#step-3---run-touch-if-required)
  * [Step 4 - Check Array for Changes](#step-4---check-array-for-changes)
  * [Step 5 - Run Sync to Update the Array](#step-5---run-sync-to-update-the-array)
  * [Step 6 - Run Scrub to Check for Silent Corruption](#step-6---run-scrub-to-check-for-silent-corruption)
  * [Step 7 - Send Final Notification Email](#step-7---send-final-notification-email)
- [Sample Output](#sample-output)
  * [Sample Notification Email](#sample-notification-email)
- [Further Examples](#further-examples)
- [Creating your own Debian Package](#creating-your-own-debian-package)
- [Return Codes](#return-codes)
- [Credits](#credits)

# Scope
This script is intended to focus just on SnapRAID and simple email notifications,
rather than adding many different features. The plan going forward is that any
additional features be accomplished via the use of additional hook scripts

This is keeping in the traditional unix philosophy of do one thing and do it well.

# Description

It is intended to be ran as a scheduled task via cronjob or systemd timers, but 
can also easily be installed and ran manually if need be.

If errors are detected, the user is notified by email and the script will
exit. **Mutt** is used for sending the emails.

Note that no attempts are made here to automate the correction of
errors, the user will have to intervene in each case if they
are detected.

Before attempting to use this script, one should ensure that **SnapRAID** is
normally functioning. That is one can run the following commands without
any error being encountered.    
1. **snapraid status**   
2. **snapraid sync**   
3. **snapraid scrub**   

See the snapraid documentation here:   
https://www.snapraid.it

The script will run out of the box with the default config file, or
no config file. However for best operation, a config file is required - see below.

The number of files deleted and moved are monitored and if either exceed
the threshold values specified in **snapraid-daily.conf**, the script will
exit and notify the user via email.

The idea here is that if a large number of accidental moves or deletions
are detected, it is probably an accident, and a sync would be a bad idea
as it will prevent the recovery of those files.

If errors are detected, the script will notify the user via email and attach
the logfile generated by the snapraid command itself that generated the error,
so the user can quickly see what the problem is from the email notification alone.

# Usage

```bash
Usage: snapraid-daily         [OPTIONS...]

  -s, --sync-only             Only Sync the Array - Do not run Scrub
  -c, --scrub-only            Only Scrub the Array - Do not run Sync
                              Note that if both of these options are omitted, the
                              default is to run sync and then scrub. They also can
                              not be specified at the same time
  -o, --override-thresholds   Ignore the deletion/moved thresholds to force a sync
  -f, --config [path-to-conf] Override default config file. Could be useful if one
                              has multiple snapraid arrays to manage on the same system
  -q, --quiet                 Suppress the output of the touch, diff, sync and scrub
                              commands for snapraid. The final status message is still
                              displayed as normal.
  -h, --help                  Print help

Manual Entries:
  Main Script:                snapraid-daily(1)      $ man snapraid-daily
  Config File:                snapraid-daily.conf(1) $ man snapraid-daily.conf
```

By default if no arguments are invoked the script will execute the following
functions in the below order. This will accomplish everything and is
sufficient to run once a day or however often is desired.

1. Check for Inital Errors    
2. Run Touch (If Required)    
3. Sync the array (If Changes are Present)    
4. Scrub the array

This can also be tweaked by the supported arguments to the script if one wants
to sync the array only or scrub the array only.

## Examples

For default operation - Sync and then scrub do:
```bash
snapraid-daily
```

To only perform sync:  
```bash
snapraid-daily -s
```

To only perform sync and override thresholds:     
```bash
snapraid-daily -s -o
```

To only perform scrub, do:     
```bash
snapraid-daily -c
```

To override the config file to **/path/to/user.conf** do:     
```bash
snapraid-daily -f /path/to/user.conf
```

If an invalid argument is specified, the script will exit.

# Installation and Setup
A package is provided for Debian and its derivatives. Note that the author
has mainly tested this just on Debian itself, but it should work on other
Debian based distros ok too.

To install the package download it from the releases page and do the following.
It's better to use **apt** rather than **dpkg** so the dependencies will be
automatically installed.

```bash
sudo apt install ./snapraid-daily_1.2.6-5_amd64.deb
```

Alternatively to install manually, do the following:

```bash
sudo apt install git # (On Debian based distros)
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily
chmod +x snapraid-daily
sudo cp snapraid-daily /usr/bin/
sudo cp ./manual/snapraid-daily.1.gz /usr/share/man/man1/
sudo cp ./manual/snapraid-daily.conf.1.gz /usr/share/man/man1/
```

Next ensure all dependencies are installed:

* grep, awk, sed, mktemp, tee (Available on pretty much every linux based system)
* mutt
* SnapRAID (This is left up to the user and not considered here)

If on Debian, one can do:
```bash
sudo apt install coreutils gawk mutt snapraid
```

Next, create the config file as discussed below.

## Config File Setup

As mentioned above, the script will run out of the box without a config file
but for best operation it will require a configuration file set up.

The location for the config file **(snapraid-daily.conf)** is tried in the
following order of preference:

1. Via the **-f** or **\--config option** if specified    
2. **/etc/snapraid-daily.conf**    
3. **snapraid-daily.conf** in the script directory    

If the config file is not found in any of the above locations, the defaults
will be used. Note that this will disable the email functionality.

The contents of **snapraid-daily.conf** should contain the following and the
syntax should be correct as per bash. The script will again exit if errors
are present in this file.

1. MuttRC File Path for Notification Emails    
2. Email Address for Notification Emails    
3. Deletion Threshold    
4. Move Threshold
5. Sync Pre Hash   
6. Scrub Percentage     
7. Scrub Age     

See the sample here:
https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config/snapraid-daily.conf

If installed via the debian package, a sample configuration
file is already placed at the 1st location above (/etc/snapraid-daily.conf) that can be
edited directly by the user.

If installing manually do the below and then manually edit it using the above
example.
```bash
sudo cp ./config/snapraid-daily.conf /etc/
```

As mentioned before, overriding the default config file can be accomplished by
using the **-f, \--config [PATH-TO-CONFIG]** as an input argument
to the script. In this case the name of the config file does not have to be **snapraid-daily.conf**.

The debian package installation will also place a sample file in the docs
location below.    
**/usr/share/doc/snapraid-daily/sample-configs/snapraid-daily.conf**

This can also be used as a template to generate the optimum config file in 
the default location:    
**/etc/snapraid-daily.conf**

Finally if the script cannot find any configuration file it will
continue with the defaults - see the below:

## Config File Contents

The main parameters included in the file are:

* **snapraid_config_file_path**    
* **muttrc_path**    
* **email_address**    
* **deletion_threshold**    
* **moved_threshold**    
* **sync_pre_hash**     
* **scrub_percent**    
* **scrub_age**    

If any of the above are missing, defaults are loaded, see below:

### snapraid\_config\_file\_path

This is the path to the main config file defining the array
for snapraid itself. It is usually **/etc/snapraid.conf**
but in the event that it is at a different location, it
can be specified here. The default is **/etc/snapraid.conf**

This is useful for the situation where the user may be running
multiple SnapRAID arrays on the same system, but for the vast
majority of users it'll be **/etc/snapraid.conf**.

To run with multiple SnapRAID arrays, one could create a copy of
the config file (snapraid-daily.conf), change this setting and
pass it to the script with the **-f, --config** option.

### muttrc\_path

This is the path for the muttrc file that is used for sending
email notifications. No emails are sent if this is omitted.
The default is empty, whereby no emails are sent.

See the notes provided in the docs directory here to set up the email
notifications. Two sample configs are provided along with instructions on
how to set them up.

* Gmail via App Passwords
* Outlook via Oauth2 
  
https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples

### email\_address

Main email address to send the notification emails to. The
default is none, thus disabling email notifications.

### deletion\_threshold

If the number of files deleted since the last sync is
found to be greater than this number, then the script
will exit and notify the user via email. Must be a postive
number. The default is **100**. To disable permanently and sync every time regardless of the number deleted, set to 0.

### moved\_threshold

As above, but for files moved. Must be a positive number.
The default is **100**. As before, to disable permanently and sync every time regardless of the number moved, set to 0.

### sync\_pre\_hash

Allows disabling of the use of the "-h" or "--pre-hash" option for snapraid
during sync operations. This will speed up sync operations but forfeit the
added safeguard that the extra preliminary hash operation provided. Set to
**no** to disable. On by default if omitted. It is recommended to leave it
on.

### scrub\_percent

The percentage of the array to scrub - should be a number between 1 and 100.
The default is **8** (or 8%).

### scrub\_age

The age of files in days to scrub. Should be a standard posive number.
The default is **21** (or 21 days).

## Additional Options

A number of additional options are provided to address some potential
edge cases. None of these are required to be specified and can be omitted.

### disable\_emails\_on\_success

Disable the notification emails on successful runs. It is the
preference of the author to always have emails sent on success
so one always knows the script is running and doing its job without
explicity checking it.

Note that this does not effect any emails sent to notify the user
about an error during sync/touch/scrub or exceeded thresholds,
those are still sent as normal.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### force\_zero

By default during **sync**, if SnapRAID encounters a file of zero
size that was not previously of zero size, it will report this as
an error and exit the sync. This is possible to happen during a
system crash in Linux systems, so is **NOT RECOMMENDED**. This option
causes SnapRAID to continue to sync anyway in this condition.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### force\_empty

If one or more of the disks are found to now be empty whereby in
the past they were not SnapRAID will report this as an error and
stop the sync. This is **NOT RECOMMENDED** but is included for
certain edge conditions that may require it. This option causes
SnapRAID to continue to sync anyway in this condition.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### force\_uuid

If the UUID of one or more disks is found to change, usually
SnapRAID will report this as an error and not complete a sync unless
another option (--force-empty) is specified. This option causes
SnapRAID to continue to sync anyway in this condition. This is also
**NOT RECOMMENDED** but is again included for certain edge conditions
that may require it.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

## Sample Config File

Shown below is the bare minimum that is required in
a snapraid-daily.conf config file for all functionality. Feel free to add
comments using **\#** accordingly.

```bash
#!/usr/bin/env bash

# Snapraid Config Path
snapraid_config_file_path="/etc/snapraid.conf"    

# Email Notification Parameters
# Muttrc File and Email Address to send notification
# emails to
muttrc_path="/opt/email_notifications/mutt/muttrc"   
email_address="server@example.com"  

# Deletion and Moved Thresholds
deletion_threshold=200 
moved_threshold=200

# Sync Pre Hash Function (on by default)
sync_pre_hash="yes"

# Scrub Age and Percent
scrub_percent=10  
scrub_age=7

# Extra Options
#disable_emails_on_success="no"

# Not Recommended Options (Off by default)
#force_zero="no"
#force_empty="no"
#force_uuid="no"
```
See a more detailed example with explanatory comments here:    
https://github.com/zoot101/snapraid-daily/blob/main/config/snapraid-daily.conf

## Setting up Email Notifications

A valid muttrc configuration is required to send email notifications.
A sample that works for Gmail can be found here along with some instructions
on how to set it up. It involves enabling 2FA within Gmail and creating an
App Password for mutt.

It should also be simple to adapt to another email provider also. The author plans
to include a number of more examples for popular email providers here also:     
https://github.com/zoot101/snapraid-daily/blob/main/docs/muttrc-examples/

Note that it's a good idea to test **mutt** out on its own with the generated
**muttrc** file before using it with the script. 

To do that, write up a sample email body in a simple text file (for example
email-body.txt) and use mutt like so to send a test email to the desired email.
(In this case example@mail.com)
```bash
mutt -F "/path/to/muttrc/file" -s "Email Subject" "example@mail.com" < "email-body.txt"
```
If the above command is successful at sending the email, then mutt is ready
to use with the script accordingly.

As mentioned above - A number of sample configs are provided along with instructions on
how to set them up.

* Gmail via App Passwords   
* Outlook via Oauth2   
* Gmail via Oauth2   

The 1st option via Gmail is much more simple, so it is the authors recommendation
to try that out 1st.    
https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples

## Automation with Systemd

By default the below systemd files are bundled with the debian package
installation, but are not enabled by default. 

* **/etc/systemd/system/snapraid-daily.service**    
* **/etc/systemd/system/snapraid-daily.timer**    
* **/etc/systemd/system/snapraid-sync.service**    
* **/etc/systemd/system/snapraid-sync.timer**    
* **/etc/systemd/system/snapraid-scrub.service**    
* **/etc/systemd/system/snapraid-scrub.timer**    

These files do the following:

1. **snapraid-daily** does a sync,then a scrub (the default).    
2. **snapraid-sync** syncs the array only.    
3. **snapraid-scrub** scrubs the array only.    

If installing manually copy the above files to the
**/etc/systemd/system/** location from the cloned directory above. Note
that this is not required if installing via the debian package.

```bash
# From the earlier directory created by "git clone" do:
sudo cp ./systemd-files/snapraid-*.service /etc/systemd/system/
sudo cp ./systemd-files/snapraid-*.timer /etc/systemd/system/

# Then Reload Systemd
sudo systemctl daemon-reload
```

It's a good idea to test the service works correctly by starting the desired
one manually.
```bash
sudo systemctl start snapraid-daily.service
```

To get detailed information one can use **journalctl**.
```bash
sudo journalctl -u snapraid-daily.service --since today
```

If the service runs without issue, the next step is to enable the timers to
run the service automatically.

To enable any one of the timers do the below - enabling the services is not required,
since they are configured as oneshots and are not intended to be ran at start up. 

```bash
sudo systemctl enable snapraid-daily.timer
```

It is not recommended to edit any of the service files directly. It is instead better
to create drop-in files by using:    
```bash
sudo systemctl edit snapraid-daily.service
```

Although to get the expected results with the timer files, it might be
necessary to edit them directly.

Some further examples are provided in the docs directory for both the
main service/timer file and also drop-in files that can be used to configure
automatic restarts or systemd hardening (see below).    
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins

Note that some examples are also provided in the docs for using **cron**
to run the script.   
https://github.com/zoot101/snapraid-daily/blob/main/docs/cron-examples/CRON_README.md

## Running as a Standard User with Systemd

Note that by default all of the above service files will run as root.
This is probably fine for most users, however if one wants to run
snapraid as a different user other than root, some further configuration
is required, namely:

* Create a directory **/etc/systemd/snapraid-.service.d/**    
* Create a file called **user.conf**, or (anything**.conf**)    
* Put the following into that file and place it in the above directory    

```bash
[Service]  
User=username   
Group=groupname
```

Where **username** and **groupname** are the user and group names of the
user one wants to run snapraid, and thus **snapraid-daily** as.

The naming of the **/etc/systemd/system/snapraid-.service.d/** directory
will cause it to be picked up by all of the systemd service unit files
installed by the script, or any services with a name of the structure:     
**snapraid-\[something\].service**

Lastly, reload systemd:     
```bash
sudo systemctl daemon-reload
```

Further example drop-in files and unit files for systemd and some
notes are included here:      
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins    
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples       

# SnapRAID Sync and Scrub Options

SnapRAID sync is invoked with the following options:   
* -c : To specify the config file for snapraid itself
* -v : Verbose Mode   
* -l : Use SnapRAID's logging function   
* -h : Read data twice during sync, as an additional safeguard against silent errors.   

SnapRAID scrub is invoked with the following options:
* -c : To specify the config file for snapraid itself
* -p : To scrub the percentage in snapraid-daily.conf
* -o : To only consider the age from snapraid-daily.conf   
* -v : Verbose Mode
* -l : Use SnapRAID's logging function 

# Detailed Operation

The Steps taken are outlined below:

## Step 1 - Initial Checks

The script carries out an initial check of everything
before it will even attempt to interact with **snapraid**.

Initially the config file **snapraid-daily.conf** is read,
and its contents are checked. If anything is undefined,
a default value is assumed. See **snapraid-daily.conf(1)**
If the main config file for snapraid itself doesn't exist,
the script will exit.

Next checks are carried out for the script dependencies:
awk, grep, sed, and snapraid itself. It will exit if
any of these are not present.

Next, a check on the first defined content file in the
snapraid config (**/etc/snapraid.conf**) is checked to
see if it exists and is writable.

This is to ensure the script is being ran as the right user,
and serves as a good sanity check to see if the content files
exist and are writable.

One could check all config files exist,  but given that there
is usually a copy on each disk, that would mean potentially
waking all the disks from standby which would be undesirable
if a sync/scrub is not ran because of a subsequent issue.

Likewise, it was decided not to check if the parity files
exist to again prevent waking the disks unless a sync or a
scrub **actually** are going to be carried out.

If there is an issue with not being able to access the parity
files or content files, the sync or scrub will fail and the
user will be notified anyway.

## Step 2 - Check SnapRAID Array Current Status
Checks the Array for Errors or if Touch is required using
**snapraid status**

If errors are encountered at this point, the script will exit
and send a notification email to the user. It will continue to
do this each time the script is invoked, and stop here until the
user intervenes to address whatever the error is.

If a sync was found to be in progress (this is - the last sync
was interrupted), and **\--scrub-only** is NOT specified, the
script will continue as the solution to this is usually to let
the sync complete. If **\--scrub-only** is specified, the script
will exit here.

A check is also carried out if **snapraid** is already in use,
ie. whether a **sync** or **scrub** etc. is currently running.
SnapRAID will not allow multiple instances of itself processing
the same array.

The script will exit in this case and the user is also notified
explicity via email of this.

## Step 3 - Run Touch if Required
If it is determined from the initial check that 1 or more files
do not have sub-zero timestamps, **snapraid touch** is ran to
add the sub-zero timestamps.

Touch of files added to the array by default will run the next
time the script is executed after the files have been added.

Snapraid is invoked with **-v** & **-l** switches to turn on
verbose mode and logging, this is to aid in quick debugging if
errors are detected during the touch.

The output is monitored for errors and if any are detected,
the script will exit, send a notification email to the user and
attach the output of the log created with the "-l" switch.

The idea here is that one can quickly know what the error is via
the notification email alone.

If it is determined that the touch operation is not required, this
step will be skipped entirely.

This step is also skipped if the **\--scrub-only** argument to the
script is used.

## Step 4 - Check Array For Changes
Runs **snapraid diff** to check the array for changes to determine
if a sync is required or not.

If no changes are detected, the script will skip the sync entirely.
If changes are detected, the sync will proceed. In the event that
the **-s, --sync-only** is used, the script will exit if no changes
are detected.

However if either the threshold for deletions or moves that are
defined in the config file **snapraid-daily.conf** are found to be
exceeded, the script will exit and notify the user via email.

The theory is that if excess deletions or moves are detected, it
could very well be accidental, and a subsequent sync could prevent
the recovery of that data.

For subsequent runs, the script will continue to do this and stop
at this point until the user intervenes. This step is skipped if the
**\--scrub-only** argument is used.

## Step 5 - Run Sync to Update the Array
Runs **snapraid sync** to update the array. The start-time and finish
time are monitored to compute the duration so it can be added to the
email.

The **-v** & **-l** switches are used to turn on verbose mode and
logging, this is to aid in quick debugging if errors are detected
during the sync operation.

The **-h** option is also used to read data a 2nd time during the sync.
This is to serve as an additional safeguard against silent errors
during what is an extreme condition for the machine whereby all
disks are spinning at the same time.

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and attach the output
of the log created with the **-l** switch to the email.

The idea here is that one can quickly know what the error is via the
notification email alone.

If it is determined that the sync operation is **NOT** required from
the above Step 4 of checking for changes, this step will be skipped
entirely.

This step is also skipped if **\--scrub-only** is active.

## Step 6 - Run Scrub to Check for Silent Corruption
Runs Scrub using the **scrub_percent** & **scrub_age** input parameters
specified in the config file snapraid-daily.conf The start-time
and finish time are computed such that is can be added to the email.

Before the scrub is carried out, **Step 3** above is repeated whereby
the array is checked for changes since the last sync.

In the default setup, where the **-c, --scrub-only** option is not
used, this check should not find any changes since a sync was carried
out moments ago. Howvever when one is using the **-c, --scrub-only**
option this may not be the case.

This is required as **snapraid** will exit with an error during a
scrub if it finds files that have been modified and not synced.

In this case, the script will exit and the user will be notified
via email explicitly that a sync is required.

The scrub is then called with the **-v** & **-l** switches to turn
on verbose mode and logging, this is to aid in quick debugging if errors
are detected during the scrub operation.

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and attach the logfile
from the output of the log created with the **-l** switch to the email.

Once again, this is to allow for quick debugging to know exactly what the
error is from the notification email alone.

If the scrub does encounter issues such as silent corruption, the status
check at the start of the script will flag them, and the script will
subsequently exit each time it is invoked until the user intervenes to
attempt a manual fix.

## Step 7 - Send Final Notification Email
If no errors are detected during the touch, sync and scrub, or just
touch & sync, or just scrub (depending on whether the **\--sync-only**
or **\--scrub-only** arguments are used):

The final condensed log file for the email is sent to the user. This
will contain an concise output of all the operations carried out and what
the result was.

# Sample Output
```bash
INFO: Using Config File: /etc/snapraid-daily.conf

##############################
# SnapRAID-DAILY Version: 1.3.7
##############################
Initialized at 14:45:29 on 30/05/2025
 * SnapRAID Version: 12.4
Input Options:
 * Run-Sync: YES
 * Sync Pre-Hash: YES
 * Run-Scrub: YES
 * Scrub-Percent: 5
 * Scrub-Age: 0 days and older
 * Override Thresholds: NO
 * Deletion Threshold: 5000
 * Moved Threshold: 5000
Run-Log is Below:

##############################
# SnapRAID-DAILY: Initial Status Check
##############################
14:45:29 : Checking current status...
14:45:48 : No Issues Found in Initial Check
14:45:48 : Touch Not Needed...

##############################
# SnapRAID-DAILY: Difference Check
##############################
14:45:48 : Checking array for changes...
  951819 equal
       0 added
       0 removed
       0 updated
       0 moved
       0 copied
       0 restored
No differences
14:46:25 : No Changes - Nothing to Sync

##############################
# SnapRAID-DAILY: Scrub
##############################
14:46:25 : Checking if Array is still up to date...
  951819 equal
       0 added
       0 removed
       0 updated
       0 moved
       0 copied
       0 restored
No differences
14:46:58 : Array is Up-to-Date - Proceeding
14:46:58 : Starting Scrub on 30/05/2025
14:46:58 : Scrubbing 5% older than 0 days...
Everything OK
15:10:21 : Scrub Completed at 30/05/2025
15:10:21 : Duration: 0 hours, 23 minutes, 23 seconds
15:10:21 : Scrub was successful
15:10:21 : Scrubbed 5% older than 0 days

Sending Final Notification Email...

##############################
# SnapRAID-DAILY: Array Status
##############################
15:10:21 : Current status of the Array is as below:

SnapRAID status report:

   Files Fragmented Excess  Wasted  Used    Free  Use Name
            Files  Fragments  GB      GB      GB
  435317       4      19       -    2519     431  85% disk1
  135689       9      16       -     528     454  54% disk2
  134452      11      17       -     560     421  57% disk3
  144523      10      27       -     632     350  65% disk4
  101798     702    3149   -48.8    1797    2138  45% disk5
 --------------------------------------------------------------------------
  951779     736    3228     0.0    6037    3797  61%


 21%|                                                                     o
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
 10%|                                                                     *
    |                                                                     *
    |                                                                     *
    |     o     o     o                                                   *
    |     *     *     *           o     o     o   ooo   * o     o     o   *
    |     *     *     *     o     *     *     *   ***   * *     *     *   *
    |*    *     *     *     *     *     *     *   ***   * *     *     *   *
  0%|*____*_____*_____*_____*_____*_____*_____*___***___*_*_____*_____*__o*
    11                    days ago of the last scrub/sync                 0

The oldest block was scrubbed 11 days ago, the median 3, the newest 0.

No sync is in progress.
6% of the array is not scrubbed.
No file has a zero sub-second timestamp.
No rehash is in progress or needed.
No error detected.
Email Sent Successfully...
```

# Sample Notification Email
```bash
##############################
# SnapRAID-DAILY Version: 1.3.7
##############################
Initialized at 14:19:03 on 30/05/2025
 * SnapRAID Version: 12.4
Input Options:
 * Run-Sync: YES
 * Sync Pre-Hash: YES
 * Run-Scrub: YES
 * Scrub-Percent: 5
 * Scrub-Age: 0 days and older
 * Override Thresholds: NO
 * Deletion Threshold: 5000
 * Moved Threshold: 5000
Run-Log is Below:

##############################
# SnapRAID-DAILY: Initial Status Check
##############################
14:19:03 : Checking current status...
14:19:22 : No Issues Found in Initial Check
14:19:22 : Touch Not Needed...

##############################
# SnapRAID-DAILY: Difference Check
##############################
14:19:22 : Checking array for changes...
14:19:57 : No Changes - Nothing to Sync

##############################
# SnapRAID-DAILY: Scrub
##############################
14:19:57 : Checking if Array is still up to date...
14:20:27 : Array is Up-to-Date - Proceeding
14:20:27 : Starting Scrub on 30/05/2025
14:20:27 : Scrubbing 5% older than 0 days...
14:43:03 : Scrub Completed at 30/05/2025
14:43:03 : Duration: 0 hours, 22 minutes, 36 seconds
14:43:03 : Scrub was successful
14:43:03 : Scrubbed 5% older than 0 days

##############################
# SnapRAID-DAILY: Array Status
##############################
14:43:03 : Current status of the Array is as below:

SnapRAID status report:

   Files Fragmented Excess  Wasted  Used    Free  Use Name
            Files  Fragments  GB      GB      GB
  435317       4      19       -    2519     431  85% disk1
  135689       9      16       -     528     454  54% disk2
  134452      11      17       -     560     421  57% disk3
  144523      10      27       -     632     350  65% disk4
  101798     702    3149   -48.8    1797    2138  45% disk5
 --------------------------------------------------------------------------
  951779     736    3228     0.0    6037    3797  61%


 16%|                                                                     o
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
    |                                                                     *
  8%|                                                                     *
    |o                                                                    *
    |*    o     o     o           o               o             o         *
    |*    *     *     *           *     o     o   *oo    *o     *     o   *
    |*    *     *     *     o     *     *     *   ***    **     *     *   *
    |*    *     *     *     *     *     *     *   ***    **     *     *   *
    |*    *     *     *     *     *     *     *   ***    **     *     *   *
  0%|*____*_____*_____*_____*_____*_____*_____*___***____**_____*_____*___*
    11                    days ago of the last scrub/sync                 0

The oldest block was scrubbed 11 days ago, the median 4, the newest 0.

No sync is in progress.
6% of the array is not scrubbed.
No file has a zero sub-second timestamp.
No rehash is in progress or needed.
No error detected.
```

# Further Examples

For examples on how to automate via systemd timers, set up a valid muttrc
config for emails, some notes on SnapRAID itself, or to use cron instead of
systemd have a look here.

* https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples
* https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins
* https://github.com/zoot101/snapraid-daily/tree/main/docs/snapraid-stuff
* https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config
* https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples
* https://github.com/zoot101/snapraid-daily/tree/main/docs/cron

# Creating your own Debian Package

Given the author uses debian as their daily driver, a debian directory containing
what is required to build a debian package is included here.

While it's not necessary, if one wants to build their own debian package, they can
do the following if they are running a debian based distribution.

```bash
sudo apt install debhelper dh-exec
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily
dpkg-buildpackage -uc -us
```

A new debian package should be created in the parent directory that can be installed
with **dpkg** or with **apt** as shown above.

# Return Codes

The Script Returns the following codes for the following conditions.
This can be useful to direct systemd or a seperate master script to
carry out further actions depending on the code. 

* 0: Success    
* 1: All Errors    
* 2: SnapRAID already in use    
* 3: Files Modified During Sync    
* 5: Thresholds Exceeded   

# Credits

Most of the script is entirely from the author, but a lot of inspiration was
got from the following similar scripts:

Original Bash Script (from Zack Reed):   
https://zackreed.me/snapraid-split-parity-sync-script/

Snapraid-Runner:   
https://github.com/Chronial/snapraid-runner

Also a bit thank you to Andrea Mazzoleni for this excellent software:    
https://github.com/amadvance/snapraid     
https://www.snapraid.it    

Lastly - Thank you for your interest in this script. Hopefully it can be of
use to other people also.
