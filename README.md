# snapraid-daily
Bash Script for the automation of all essential SnapRAID functions with
in-built email notifications and monitoring of the number of deletions/moves.

# Introduction 
Thank you for your interest in this script. Snapraid is very good software,
but lacks any default automation or notification ability.

That is where this script comes in, it is intended to be an all-in-one
script for the automation of snapraid.

There are many other scripts out there that essentially do the same thing,
and some are probably better than this one. However, none of them had exactly
the features the author wanted or were more complex than desired.

This led to this script being created by the author. It has worked quite well
for the author for many years up to this date, and hopefully prove useful to others.

The broad goal here is to be an all-in-one script to automate the necessary
snapraid functions that can be scheduled accordingly and do it in a simple manner.

# Scope
This script is intended to focus just on SnapRAID and simple email notifications,
rather than adding many different features.

This is keeping in the traditional unix philosophy of do one thing and do it well.

# Description

It is intended to be ran as a scheduled task via cronjob or systemd timers, but 
can also easily be installed and ran manually if need be.

If errors are detected, the user is notified by email and the script will
exit. **Mutt** is used for sending the emails.

Note that no attempts are made here to automate the correction of
errors automatically, the user will have to intervene in each case if they
are detected.

Before attempting to use this script, one should ensure that **SnapRAID** is
normally functioning. That is one can run the following commands without
any error being encountered. See the snapraid documentation here:
https://www.snapraid.it

1. **snapraid status**   
2. **snapraid sync**   
3. **snapraid scrub**   

While the script will run out of the box with the default config, for best
operation, a config file is required - see below.

The number of files deleted and moved are monitored and if either exceed
the threshold values specified in **snapraid-daily.conf**, the script will
exit and notify the user via email.

The idea here is that if a large number of accidental moves or deletions
are detected, it is probably an accident, and a sync would be a bad idea
as it will prevent the recovery of those files.

If errors are detected, the script will notify the user via email and attach
the logfile generated by the snapraid command itself that generated the error,
so the user can quickly see what the problem is from the email notification alone.

# Usage

```bash
Usage: snapraid-daily         [OPTIONS...]

  -s, --sync-only             Only Sync the Array - Do not run Scrub
  -c, --scrub-only            Only Scrub the Array - Do not run Sync
                              Note that if both of these options are omitted, the
                              default is to run sync and then scrub. They also can
                              not be specified at the same time
  -o, --override-thresholds   Ignore the deletion/moved thresholds to force a sync
  -f, --config [path-to-conf] Override default config file. Could be useful if one
                              has multiple snapraid arrays to manage on the same system
  -q, --quiet                 Suppress the output of the touch, diff, sync and scrub
                              commands for snapraid. The final status message is still
                              displayed as normal.
  -h, --help                  Print help

Manual Entries:
  Main Script:                snapraid-daily(1)      $ man snapraid-daily
  Config File:                snapraid-daily.conf(1) $ man snapraid-daily.conf
```

By default if no arguments are invoked the script will execute the following
functions in the below order. This will accomplish everything and is
sufficient to run once a day or however often is desired.

1. Check for Inital Errors    
2. Run Touch (If Required)    
3. Sync the array (If Changes are Present)    
4. Scrub the array

This can also be tweaked by the supported arguments to the script if one wants
to sync the array only or scrub the array only.

## Examples:

For default operation - Sync and then scrub do:
```bash
snapraid-daily
```

To only perform sync:  
```bash
snapraid-daily -s
```

To only perform sync and override thresholds:     
```bash
snapraid-daily -s -o
```

To only perform scrub, do:     
```bash
snapraid-daily -c
```

To override the config file to **/path/to/user.conf** do:     
```bash
snapraid-daily -f /path/to/user.conf
```

If an invalid argument is specified, the script will exit.

# Installation and Setup
A package is provided for Debian and its derivatives. Note that the author
has mainly tested this just on Debian itself, but it should work on other
Debian based distros ok too.

To install the package download it from the releases page and do the following.
It's better to use **apt** rather than **dpkg** so the dependencies will be
automatically installed.

```bash
sudo apt install ./snapraid-daily_1.2.6-5_amd64.deb
```

Alternatively to install manually, do the following:

```bash
sudo apt install git # (On Debian based distros)
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily
chmod +x snapraid-daily
sudo cp snapraid-daily /usr/bin/
sudo cp ./manual/snapraid-daily.1.gz /usr/share/man/man1/
sudo cp ./manual/snapraid-daily.conf.1.gz /usr/share/man/man1/
```

Next ensure all dependencies are installed:

* grep,awk,sed,mktemp,cut - Available on pretty much every linux based system
* SnapRAID (This is left up to the user and not considered here)

Next, create the config file as discussed below.

# Config File (snapraid-daily.conf)

As mentioned above, the script will run out of the box without a config file
but its functionality is somewhat limited as a result.

The location for the config file **(snapraid-daily.conf)** is tried in the
following order of preference:

1. **Via the -f or \--config option if specified**    
2. **/etc/snapraid-daily.conf**    
3. **snapraid-daily.conf** in the script directory    

If the config file is not found in any of the above locations, the defaults
will be used. Note that this will disable the email functionality.

The contents of **snapraid-daily.conf** should contain the following and the
syntax should be correct as per bash. The script will again exit if errors
are present in this file.

1. MuttRC File Path for Notification Emails    
2. Email Address for Notification Emails    
3. Deletion Threshold    
4. Move Threshold    
5. Scrub Percentage     
6. Scrub Age     

See the sample here:
https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config/snapraid-daily.conf

If installed via the debian package, a sample configuration
file is already placed at the 1st location above that can be
edited directly by the user.

If installing manually do the below and then manually edit it using the above
example.
```bash
sudo cp ./config/snapraid-daily.conf /etc/
```

Note that overriding the default config file can also be accomplished by
using the **-f, \--config [PATH-TO-CONFIG]** as an input argument
to the script.

The debian package installation will also place a sample file in the docs
location below.    
**/usr/share/doc/snapraid-daily/sample-configs/snapraid-daily.conf**

This can also be used as a template to generate the optimum config file in 
the default location:    
**/etc/snapraid-daily.conf**

Finally if the script cannot find any configuration file it will
continue with the defaults - see the below:

## Config File Contents

The main parameters included in the file are:

* **snapraid_config_file_path**    
* **muttrc_path**    
* **email_address**    
* **deletion_threshold**    
* **moved_threshold**    
* **scrub_percent**    
* **scrub_age**    

If any of the above are missing, defaults are loaded, see below:

### snapraid\_config\_file\_path

This is the path to the main config file defining the array
for snapraid itself. It is usually **/etc/snapraid.conf**
but in the event that it is at a different location, it
can be specified here. The default is **/etc/snapraid.conf**

This is useful for the situation where the user may be running
multiple SnapRAID arrays on the same system, but for the vast
majority of users it'll be **/etc/snapraid.conf**.

### muttrc\_path

This is the path for the muttrc file that is used for sending
email notifications. No emails are sent if this is omitted.
The default is empty, whereby no emails are sent.

See the example here to set up the email notifications. A sample config
is provided for gmail along with instructions to set it up. It should be
simple to adapt for other email providers also:    
https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples/muttrc

### email\_address

Main email address to send the notification emails to. The
default is none, thus disabling email notifications.

### deletion\_threshold

If the number of files deleted since the last sync is
found to be greater than this number, then the script
will exit and notify the user via email. Must be a postive
number. The default is **100**

### moved\_threshold

As above, but for files moved. Must be a positive number.
The default is **100**

### scrub\_percent

The percentage of the array to scrub should be a number between 1 and 100.
The default is **8** (or 8%).

### scrub\_age

The age of files in days to scrub. Should be a standard posive number.
The default is **21** (or 21 days).

# Sample File Contents (snapraid-daily.conf)

Shown below is the bare minimum that is required in
a snapraid-daily.conf config file for all functionality. Feel free to add
comments using **\#** accordingly.

```bash
#!/usr/bin/env bash

# Snapraid Config Path
snapraid_config_file_path="/etc/snapraid.conf"    

# Email Notification Parameters
# Muttrc File and Email Address to send notification
# emails to
muttrc_path="/opt/email_notifications/mutt/muttrc"   
email_address="server@example.com"  

# Deletion and Moved Thresholds
deletion_threshold=200 
moved_threshold=200

# Scrub Age and Percent
scrub_percent=10  
scrub_age=7
```

# Setting up Email Notifications

A valid muttrc configuration is required to send email notifications.
A sample that works for Gmail can be found here along with some instructions
on how to set it up.

It should be simple to adapt to another email provider also.    
https://github.com/zoot101/snapraid-daily/blob/main/docs/muttrc-examples/muttrc

# Automation with Systemd

By default the below systemd files are bundled with the debian package
installation, but are not enabled by default. 

* **/etc/systemd/system/snapraid-daily.service**    
* **/etc/systemd/system/snapraid-daily.timer**    
* **/etc/systemd/system/snapraid-sync.service**    
* **/etc/systemd/system/snapraid-sync.timer**    
* **/etc/systemd/system/snapraid-scrub.service**    
* **/etc/systemd/system/snapraid-scrub.timer**    

These files do the following:

1. **snapraid-daily** does a sync,then a scrub (the default).    
2. **snapraid-sync** syncs the array only.    
3. **snapraid-scrub** scrubs the array only.    

If installing manually copy the above files to the
**/etc/systemd/system/** location from the cloned directory above. Note
that this is not required if installing via the debian package.

```bash
sudo cp ./systemd-files/snapraid-*.service /etc/systemd/system/
sudo cp ./systemd-files/snapraid-*.timer /etc/systemd/system/

# Then Reload Systemd
systemctl daemon-reload
```

It's a good idea to test the service works correctly by starting the desired
one manually.
```bash
systemctl start snapraid-daily.service
```

To get detailed information one can use **journalctl**.
```bash
journalctl -u snapraid-daily.service --since today
```

If the service runs without issue, the next step is to enable the timers to
run the service automatically.

To enable any one of the timers do the below - enabling the services is not required,
since they are configured as oneshots and are not intended to be ran at start up. 

```bash
systemctl enable snapraid-daily.timer
```

It is not recommended to edit any of the service files directly. It is instead better
to create drop-in files by using:    
```bash
systemctl edit snapraid-daily.service
```

Although to get the expected results with the timer files, it might be
necessary to edit them directly.

Some further examples are provided in the docs directory for both the
main service/timer file and also drop-in files that can be used to configure
automatic restarts or systemd hardening (see below).    
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins

Note that some examples are also provided in the docs for using **cron**
to run the script.

## Running as a Non-Root User via Systemd

Note that by default all of the above service files will run as root.
This is probably fine for most users, however if one wants to run
snapraid as a different user other than root, some further configuration
is required, namely:

* Create a directory **/etc/systemd/snapraid-.service.d/**    
* Create a file called **user.conf**, or (anything**.conf**)    
* Put the following into that file and place it in the above directory    

```bash
[Service]  
User=username   
Group=groupname
```

Where **username** and **groupname** are the user and group names of the
user one wants to run snapraid, and thus **snapraid-daily** as.

The naming of the **/etc/systemd/system/snapraid-.service.d/** directory
will cause it to be picked up by all of the systemd service unit files
installed by the script, or any services with a name of the structure:     
**snapraid-\[something\].service**

Lastly, reload systemd:     
```bash
systemctl daemon-reload
```

Further example drop-in files and unit files for systemd and some
notes are included here:      
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins    
https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples       

# Return Codes

The Script Returns the following codes for the following conditions.
This can be useful to direct systemd or a seperate master script to
carry out further actions depending on the code. It is planned to add
further return codes the future.

* 0: Success    
* 1: All Errors    
* 2: SnapRAID already in use    
* 3: Files Modified During Sync    
* 5: Thresholds Exceeded    

# Sample Output
```bash
mark : server @ ~ $ snapraid-daily -s -q
Using Config File: /etc/snapraid-daily.conf

##############################
# SnapRAID-DAILY Version: 1.2.6
##############################
Initialized at 10:44:25 on 25/05/2025
Input Options:
Run-Sync: YES
Run-Scrub: NO
Override Deletion/Moved Thresholds: NO
Deletion Threshold: 200
Moved Threshold: 200
Run-Log is Below:

##############################
# SnapRAID-DAILY: Initial Status Check
##############################
10:44:25 : Checking current status...
10:44:41 : No Issues Found in Inital Check
10:44:41 : Touch Not Needed...

##############################
# SnapRAID-DAILY: Difference Check
##############################
10:44:41 : Checking array for changes...
10:45:14 : No Changes - Nothing to Sync

Sending Final Notification Email...

##############################
# SnapRAID-DAILY: Array Status
##############################
10:45:14 : Current status of the Array is as below:

Self test...
Loading state from /Appdata/snapraid/content-file/marks-server.content...
Using 3906 MiB of memory for the file-system.
SnapRAID status report:

   Files Fragmented Excess  Wasted  Used    Free  Use Name
            Files  Fragments  GB      GB      GB
   26351      72     160   -76.5    8311    1605  83% media1
   26584      36      67   -76.4    7959    1956  80% media2
   20794      30      35   -77.4    8338    1578  84% media3
    8053      49     105   -79.7    7645    2270  77% media4
   50597     375    1938   -73.6    5598    4317  56% media5
  473820     701   15765   -20.1    5856    4059  59% media6
  444633    1489    4942   -16.6    6470    3444  65% media7
    3688       5       5   -80.3    2849    7067  28% media8
 --------------------------------------------------------------------------
 1054520    2757   23017     0.0   53030   26299  66%


 12%|                                 o      o         o      o        o
    |                o      o         *      *         *      *        *
    |                *      *         *      *         *      *        *
    |                *      *         *      *         *      *        *
    |                *      *         *      *         *      *        *
    |                *      *         *      *         *      *        *
    |       *        *      *         *      *         *      *        *
  6%|       *        *      *         *      *         *      *        *
    |       *        *      *         *      *         *      *        *
    |       *        *      *         *      *         *      *        *
    |       *        *      *         *      *         *      *        *
    |       *        *      *         *      *         *      *        *
    |       *        *      *         *      *         *  o   *        *
    |o      *        *      *o     o  *   o  *         *  *   *        *
  0%|*o_oooo*oooooo_o*ooo_oo*oo_ooooo_*oooo_o*oooo_oooo*_o*ooo*ooooo_oo*ooo
    29                    days ago of the last scrub/sync                 0

The oldest block was scrubbed 29 days ago, the median 12, the newest 0.

No sync is in progress.
9% of the array is not scrubbed.
No file has a zero sub-second timestamp.
No rehash is in progress or needed.
No error detected.
Email Sent Successfully...
```

# Sample Notification Email
```bash
##############################
# SnapRAID-DAILY Version: 1.2.6
##############################
Initialized at 06:00:00 on 25/05/2025
Input Options:
Run-Sync: YES
Run-Scrub: YES
Scrub-Percent: 15
Scrub-Age: 2 days
Override Deletion/Moved Thresholds: NO
Deletion Threshold: 1000
Moved Threshold: 1000
Run-Log is Below:

##############################
# SnapRAID-DAILY: Initial Status Check
##############################
06:00:00 : Checking current status...
06:00:16 : No Issues Found in Inital Check
06:00:16 : Touch Required on 66 files...

##############################
# SnapRAID-DAILY: Touch
##############################
06:00:16 : Starting Touch...
06:01:02 : Touch Completed

##############################
# SnapRAID-DAILY: Difference Check
##############################
06:01:02 : Checking array for changes...
06:01:48 : Changes Detected
Added: 335
Removed: 9
Updated: 18
Moved: 0
Copied: 0
Restored: 0

##############################
# SnapRAID-DAILY: Sync
##############################
06:01:48 : Starting Sync on 25/05/2025...
06:03:38 : Sync Completed on 25/05/2025
06:03:38 : Duration: 0 hours, 1 minutes, 50 seconds
06:03:38 : Sync was Successful
06:03:38 : Array Changes Found & Updated:
Added: 335
Removed: 9
Updated: 18
Moved: 0
Copied: 0
Restored: 0

##############################
# SnapRAID-DAILY: Scrub
##############################
06:03:38 : Checking if Array is still up to date...
06:04:21 : Array is Up-to-Date - Proceeding
06:04:21 : Starting Scrub on 25/05/2025
06:04:21 : Scrubbing 15% older than 2 days...
07:19:21 : Scrub Completed at 25/05/2025
07:19:21 : Duration: 1 hours, 15 minutes, 0 seconds
07:19:21 : Scrub was successful
07:19:21 : Scrubbed 15% older than 2 days

##############################
# SnapRAID-DAILY: Array Status
##############################
07:19:21 : Current status of the Array is as below:

Self test...
Loading state from /opt/snapraid/ballyryan-nas.content...
Using 1340 MiB of memory for the file-system.
SnapRAID status report:

   Files Fragmented Excess  Wasted  Used    Free  Use Name
            Files  Fragments  GB      GB      GB
  220631     180     653       -    1628     338  83% media1
  333341     530    1987       -    1936    1013  66% media2
  581601     275     888       -    1537     427  79% media3
  408485    1844    6475    -3.3    2933    1000  74% media4
 --------------------------------------------------------------------------
 1544058    2829   10003     0.0    8036    2780  74%


 15%|  *          o             o             o             o             o
    |  *          *             *             *             *             *
    |  *          *             *             *             *             *
    |  *          *             *             *             *             *
    |  *          *             *             *             *             *
    |  *          *             *             *             *             *
    |  *          *             *             *             *             *
  7%|* *          *             *             *             *             *
    |* *          *             *             *             *             *
    |* *          *             *             *             *             *
    |* *          *             *             *             *             *
    |* *          *             *             *             *             *
    |* *          *             *             *             *             *
    |* *          *             *             *             *             *
  0%|*_*__________*_____________*_____________*_____________*_____________*
     5                    days ago of the last scrub/sync                 0

The oldest block was scrubbed 5 days ago, the median 3, the newest 0.

No sync is in progress.
2% of the array is not scrubbed.
No file has a zero sub-second timestamp.
No rehash is in progress or needed.
No error detected
```

# Further Examples

For examples on how to automate via systemd timers, set up a valid muttrc
config for emails, or to use cron instead of systemd have a look here.

* https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples
* https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins
* https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config
* https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples
* https://github.com/zoot101/snapraid-daily/tree/main/docs/cron

Lastly - Thank you for your interest in this script. Hopefully it can be of
use to other people also.

# Creating your own Debian Package

Given the author uses debian as their daily driver, a debian directory containing
what is required to build a debian package is included here.

While it's not necessary, if one wants to build their own debian package, they can
do the following if they are running a debian based distribution.

```bash
sudo apt install debhelper dh-exec
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily
dpkg-buildpackage -uc -us
```

A new debian package should be created in the parent directory that can be installed
with **dpkg** or with **apt** as shown above.

# Credits

Most of the script is entirely from the author, but a lot of inspiration was
got from the following similar scripts:

Original Bash Script (from Zack Reed):   
https://zackreed.me/snapraid-split-parity-sync-script/

Snapraid-Runner:   
https://github.com/Chronial/snapraid-runner

Also a bit thank you to Andrea Mazzoleni for this excellent software:    
https://github.com/amadvance/snapraid     
https://www.snapraid.it    

# Author

Mark Finnan (mfinnan101@gmail.com)

