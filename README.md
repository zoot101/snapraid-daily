# SnapRAID-DAILY

Simple Bash Script for the automation of all essential SnapRAID functions with
in-built email notifications and monitoring of the number of deletions/moves.

Customisable through the use of external hooks. See some examples here:    
* https://github.com/zoot101/snapraid-daily-hooks
* Hooks are provided above for **Apprise**, **Healthchecks.io**, and to manage a list of services

# Introduction 

Thank you for your interest in this script! SnapRAID is very good software,
but lacks any default automation or notification ability.

That is where this script comes in, it is intended to be an all-in-one
script for the automation of SnapRAID.

There are other scripts out there that essentially do the same thing. However, none
of them had exactly had the features the author wanted.

This led to this script being created by the author. It has worked extremely well
for the author for many years up to this date, and hopefully prove useful to others,
hence the reason for publishing it here in Github.

The broad goal here is to be an all-in-one script to automate the necessary
SnapRAID functions that can be scheduled accordingly and do it in a simple manner.

# Table of Contents

- [Scope](#scope)
- [Description](#description)
- [Usage](#usage)
  * [Examples](#examples)
- [Installation and Setup](#installation-and-setup)
  * [Config File Setup](#config-file-setup)
  * [Config File Contents](#config-file-contents)
  * [Sample Config File](#sample-config-file)
  * [Setting Up Email Notifications](#setting-up-email-notifications)
  * [Automation with Systemd](#automation-with-systemd)
  * [Running as a Non-Root User with Systemd](#running-as-a-standard-user-with-systemd)
  * [External Hooks](#external-hooks)
    - [Notification Hook](#notification-hook)
    - [Start and End Hooks](#start-and-end-hooks)
- [SnapRAID Sync and Scrub Options](#snapraid-sync-and-scrub-options)
- [Detailed Operation](#detailed-operation)
  * [Step 1 - Initial Checks](#step-1---initial-checks)
  * [Step 2 - Check SnapRAID Array Current Status](#step-2---check-snapraid-array-current-status)
  * [Step 3 - Run Start Hook if Given](#step-3---run-start-hook-if-given)
  * [Step 4 - Run Touch if Required](#step-4---run-touch-if-required)
  * [Step 5 - Check Array for Changes](#step-5---check-array-for-changes)
  * [Step 6 - Run Sync to Update the Array](#step-6---run-sync-to-update-the-array)
  * [Step 7 - Run Scrub to Check for Silent Corruption](#step-7---run-scrub-to-check-for-silent-corruption)
  * [Step 8 - Run End Hook If Given](#step-8---run-end-hook-if-given)
  * [Step 9 - Send Final Notification Email](#step-9---send-final-notification-email)
  * [Step 10 - Run Notification Hook if Given](#step-10---run-notification-hook-if-given)
- [Sample Output](#sample-output)
- [Further Examples](#further-examples)
- [Creating your own Debian Package](#creating-your-own-debian-package)
- [Return Codes](#return-codes)
- [Credits](#credits)

# Scope

This script is intended to focus just on SnapRAID and simple email notifications,
rather than adding many different features. This is keeping in the traditional unix
philosophy of do one thing and do it well.

Additional functionality is accomplished through the use of Start/End and
Notification Hooks. See the additional repo here:

* [https://github.com/zoot101/snapraid-daily-hooks](https://github.com/zoot101/snapraid-daily-hooks)

# Description

It is intended to be ran as a scheduled task via Systemd Timers, but 
can also easily be installed and ran manually if need be.

If errors are detected, the user is notified by email and the script will
exit. **Mutt** is used for sending the emails.

Note that no attempts are made here to automate the correction of
errors, the user will have to intervene in each case if they
are detected.

Before attempting to use this script, one should ensure that **SnapRAID** is
normally functioning. That is one can run the following commands without
any error being encountered.    
1. **snapraid status**   
2. **snapraid sync**   
3. **snapraid scrub**   

See the snapraid documentation here:   
* [https://www.snapraid.it](https://www.snapraid.it)

The script will run out of the box with the default config file, or
no config file. However for best operation, a config file is required - see below.

The number of files deleted, moved, or updated are monitored and if any exceed
the threshold values specified in **snapraid-daily.conf**, the script will
exit and notify the user via email.

The idea here is that if a large number of accidental moves, deletions or updates
are detected, it is probably an accident, and a sync would be a bad idea
as it will prevent the recovery of those files.

If errors are detected, the script will notify the user via email and attach
the logfile generated by the SnapRAID command itself that generated the error,
so the user can quickly see what the problem is from the email notification alone.

# Usage

```bash
Usage: snapraid-daily         [OPTIONS...]

  -s, --sync-only             Only Sync the Array - Do not run Scrub
  -c, --scrub-only            Only Scrub the Array - Do not run Sync
                              Note that if both of these options are omitted, the
                              default is to run sync and then scrub. They also can
                              not be specified at the same time
  -o, --override-thresholds   Ignore the deletion/moved thresholds to force a sync
  -f, --config [path-to-conf] Override default config file. Could be useful if one
                              has multiple snapraid arrays to manage on the same system
  -q, --quiet                 Suppress the output of the touch, diff, sync and scrub
                              commands for snapraid. The final status message is still
                              displayed as normal.
  -h, --help                  Print help

Manual Entries:
  Main Script:                snapraid-daily(1)      $ man snapraid-daily
  Config File:                snapraid-daily.conf(1) $ man snapraid-daily.conf
```

By default if no arguments are invoked the script will execute the following
functions in the below order. This will accomplish everything and is
sufficient to run once a day or however often is desired.

1. Check for Inital Errors    
2. Run Touch (If Required)    
3. Sync the array (If Changes are Present)    
4. Scrub the array

This can also be tweaked by the supported arguments to the script if one wants
to sync the array only or scrub the array only.

## Examples

For default operation - Sync and then scrub do:
```bash
snapraid-daily
```

To only perform sync:  
```bash
snapraid-daily -s
```

To only perform sync and override thresholds:     
```bash
snapraid-daily -s -o
```

To only perform scrub, do:     
```bash
snapraid-daily -c
```

To override the config file to **/path/to/user.conf** do:     
```bash
snapraid-daily -f /path/to/user.conf
```

If an invalid argument is specified, the script will exit.

# Installation and Setup

A package is provided for Debian and its derivatives. Note that the author
has mainly tested this just on Debian itself (Bullseye, Bookworm and Trixie),
but it should work on other Debian based distros ok too. The script has also
been tested on Fedora via manual installation.

Its highly recommended to use the package if one is running a debian based
distro so the dependencies are handled automatically.

To install the package download it from the releases page below and do the following.
It's better to use **apt** rather than **dpkg** so the dependencies will be
automatically installed.

* [https://github.com/zoot101/snapraid-daily/releases](https://github.com/zoot101/snapraid-daily/releases)

Install the package like so:

```bash
sudo apt update
sudo apt install ./snapraid-daily_1.4.1-1_amd64.deb
```

Alternatively to install manually, do the following:

```bash
# Install git
sudo apt install git # (On Debian based distros)
sudo dnf install git-core # (On Fedora)

# Clone the Repo
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily

# Install the main script
chmod +x snapraid-daily
sudo cp snapraid-daily /usr/bin/

# Install the sample config file to the
# default location
sudo cp ./config/snapraid-daily.conf /etc/

# Install the manual entries
sudo cp ./manual/snapraid-daily.1.gz /usr/share/man/man1/
sudo cp ./manual/snapraid-daily.conf.1.gz /usr/share/man/man1/
```

Next ensure all dependencies are installed:

* grep, awk, sed, mktemp, tee (Available on pretty much every linux based system)
* mutt
* SnapRAID (This is left up to the user and not considered here)

If on Debian, one can do:
```bash
# On Debian
sudo apt install coreutils gawk mutt snapraid

# On Fedora
sudo dnf install coreutils gawk mutt snapraid
```

Next, create the config file as discussed below.

## Config File Setup

As mentioned above, the script will run out of the box without a config file
but for best operation it will require a configuration file set up.

The location for the config file **(snapraid-daily.conf)** is tried in the
following order of preference:

1. Via the **-f** or **\--config option** if specified    
2. **/etc/snapraid-daily.conf**    
3. **snapraid-daily.conf** in the script directory    

If the config file is not found in any of the above locations, the defaults
will be used. Note that this will disable the email functionality.

The contents of **snapraid-daily.conf** should contain the following and the
syntax should be correct as per bash. The script will again exit if errors
are present in this file.

1. MuttRC File Path for Notification Emails    
2. Email Address for Notification Emails    
3. Deletion Threshold    
4. Moved Threshold
5. Updated Threshold
6. Sync Pre Hash   
7. Scrub Percentage     
8. Scrub Age     

See the sample here:
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config/snapraid-daily.conf](https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config/snapraid-daily.conf)

If installed via the debian package, a sample configuration
file is already placed at the 1st location above (/etc/snapraid-daily.conf) that can be
edited directly by the user.

As mentioned before, overriding the default config file can be accomplished by
using the **-f, \--config [PATH-TO-CONFIG]** as an input argument
to the script. In this case the name of the config file does not have to be **snapraid-daily.conf**.

The debian package installation will also place a sample file in the docs
location below.

* **/usr/share/doc/snapraid-daily/sample-configs/snapraid-daily.conf**

This can also be used as a template to generate the optimum config file in 
the default location:

* **/etc/snapraid-daily.conf**

Finally if the script cannot find any configuration file it will
continue with the defaults - see the below:

## Config File Contents

The main parameters included in the file are:

* **snapraid_config_file_path**    
* **muttrc_path**    
* **email_address**    
* **deletion_threshold**    
* **moved_threshold**
* **updated_treshold**    
* **sync_pre_hash**     
* **scrub_percent**    
* **scrub_age**    

If any of the above are missing, defaults are loaded, see below:

### snapraid\_config\_file\_path

This is the path to the main config file defining the array
for SnapRAID itself. It is usually **/etc/snapraid.conf**
but in the event that it is at a different location, it
can be specified here. The default is **/etc/snapraid.conf**

This is useful for the situation where the user may be running
multiple SnapRAID arrays on the same system, but for the vast
majority of users it'll be **/etc/snapraid.conf**.

To run with multiple SnapRAID arrays, one could create a copy of
the config file (snapraid-daily.conf), change this setting and
pass it to the script with the **-f, --config** option.

### muttrc\_path

This is the path for the muttrc file that is used for sending
email notifications. No emails are sent if this is omitted.
The default is empty, whereby no emails are sent.

See the notes provided in the docs directory here to set up the email
notifications.

* [https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples](https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples)

Three sample configs are provided along with instructions on
how to set them up.

* Gmail via App Passwords
* Outlook via Oauth2
* Gmail via Oauth2   

Comment out to disable email notifications. If one wants to use an
alternative form of notifcation either instead of emails or inaddtion
to them see the Notification Hook below.

### email\_address

Main email address to send the notification emails to. The
default is none, thus disabling email notifications.

This can also be commented out to disable email notifications.

### deletion\_threshold

If the number of files deleted since the last sync is
found to be greater than this number, then the script
will exit and notify the user via email. Must be a postive
number. The default is **100**. To disable permanently and
sync every time regardless of the number deleted, set to 0.

### moved\_threshold

As above, but for files moved. Must be a positive number.
The default is **100**. As before, to disable permanently and
sync every time regardless of the number moved, set to 0.

### updated\_threshold

Also as above, but for files updated. Must be a positive number. Set to
zero to disable permanently and sync each time regardless of the number
of updated files. If omitted, the default is **100**

### sync\_pre\_hash

Allows disabling of the use of the "-h" or "--pre-hash" option for snapraid
during sync operations. This will speed up sync operations but forfeit the
added safeguard that the extra preliminary hash operation provided. Set to
**no** to disable. On by default if omitted. It is recommended to leave it
on.

### scrub\_percent

The percentage of the array to scrub - should be a number between 1 and 100.
The default is **8** (or 8%).

### scrub\_age

The age of files in days to scrub. Should be a standard posive number.
The default is **21** (or 21 days).

## Additional Options

A number of additional options are provided to address some potential
edge cases. None of these are required to be specified and can be omitted.

### disable\_emails\_on\_success

Disable the notification emails on successful runs. It is the
preference of the author to always have emails sent on success
so one always knows the script is running and doing its job without
explicity checking it.

Note that this does not effect any emails sent to notify the user
about an error during sync/touch/scrub or exceeded thresholds,
those are still sent as normal.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable. Note that if one is using the custom notification hook
(see below), this option also disables calls to that on successful
runs.

### force\_zero

By default during **sync**, if SnapRAID encounters a file of zero
size that was not previously of zero size, it will report this as
an error and exit the sync. This is possible to happen during a
system crash in Linux systems, so is **NOT RECOMMENDED**. This option
causes SnapRAID to continue to sync anyway in this condition.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### force\_empty

If one or more of the disks are found to now be empty whereby in
the past they were not SnapRAID will report this as an error and
stop the sync. This is **NOT RECOMMENDED** but is included for
certain edge conditions that may require it. This option causes
SnapRAID to continue to sync anyway in this condition.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### force\_uuid

If the UUID of one or more disks is found to change, usually
SnapRAID will report this as an error and stop the sync. This option causes
SnapRAID to continue to sync anyway in this condition. This is also
**NOT RECOMMENDED** but is again included for certain edge conditions
that may require it.

Set to \"yes\" to use, leave commented out or set to \"no\" to
disable.

### start\_hook

Specify a path to a hook script that is called when the script
completes its initial checks and determines the intial status of the
array is OK but before **SnapRAID** touch/diff/sync/scrub operations
are carried out. Must be executable. Comment out or omit out if not using.

```bash
start_hook="/path/to/hook"
```

See the section on hooks later for more information.

### end\_hook

Specify a path to a hook script that is called when the script completes all
sync/scrub operations and before sending the final notification email. This is also
called if the script exits in an error condition. Must be executable. Comment
out or omit if not using.

```bash
end_hook="/path/to/end/hook"
```

Can be the same as the start hook if it accepts the "start" and "end" arguments. See
the section on hooks later for more information.

### notification\_hook

Specify a path to a custom notification hook here if an alternative form of
notification to emails with **mutt** is preferred. Note that it must be executable. It
can used instead of or in addition to the emails if desired. Comment out or omit if
not using.

```bash
notification_hook="/path/to/notification/hook/script"
```

As above, see the section on hooks later for more information.

### Hook Variables

If any variables are required for the start/end or notification hooks they can be
specified in the config file through the use of "export" - Example:

```bash
export var1="whatever etc."
```

This is better than requiring additional configuration files for hook scripts.
Remember not to forget the "export"!

## Sample Config File

Shown below is the bare minimum that is required in
a snapraid-daily.conf config file for all functionality. Feel free to add
comments using **\#** accordingly.

```bash
# Snapraid Config Path
snapraid_config_file_path="/etc/snapraid.conf"    

# Email Notification Parameters
# Muttrc File and Email Address to send notification
# emails to
muttrc_path="/opt/email_notifications/mutt/muttrc"   
email_address="server@example.com"  

# Deletion and Moved Thresholds
deletion_threshold=200 
moved_threshold=200
updated_threshold=200

# Sync Pre Hash Function (on by default)
sync_pre_hash="yes"

# Scrub Age and Percent
scrub_percent=10  
scrub_age=7

# Extra Options
#disable_emails_on_success="no"

# Not Recommended Options (Off by default)
#force_zero="no"
#force_empty="no"
#force_uuid="no"

# Hooks
#start_hook="/path/to/start/hook"
#end_hook="/path/to/end/hook"
#notification_hook="/path/to/notification/hook"

```
See a more detailed example with explanatory comments here:

* [https://github.com/zoot101/snapraid-daily/blob/main/config/snapraid-daily.conf](https://github.com/zoot101/snapraid-daily/blob/main/config/snapraid-daily.conf) 

See also an example that uses the hook scripts from the SnapRAID-DAILY-Hooks repo
here: [https://github.com/zoot101/snapraid-daily-hooks](https://github.com/zoot101/snapraid-daily-hooks)

* [https://github.com/zoot101/snapraid-daily/blob/main/docs/sample-config/snapraid-daily.conf](https://github.com/zoot101/snapraid-daily/blob/main/docs/sample-config/snapraid-daily.conf)   

## Setting up Email Notifications

The main notification method the script uses is emails. In the opinion of the author,
email is be best way to get detailed information.

A valid muttrc configuration is required to send email notifications.

The following 3 sample configurations are provided in the docs directory below.

* Gmail via App Passwords
* Outlook via Oauth2
* Gmail via Oauth2

Detailed instructions are provided in the below link on how to set **mutt** up
to send emails with the script.
 
* [https://github.com/zoot101/snapraid-daily/blob/main/docs/muttrc-examples/](https://github.com/zoot101/snapraid-daily/blob/main/docs/muttrc-examples/)

If desired, to disable emails entirely and rely upon an alternative form of notification comment
out the **muttrc_path** or **email_address** in the config file and use the
**notification_hook** instead (see below).

## Automation with Systemd

By default the below systemd files are bundled with the debian package
installation, but are not enabled by default. 

* **/etc/systemd/system/snapraid-daily.service**    
* **/etc/systemd/system/snapraid-daily.timer**    
* **/etc/systemd/system/snapraid-sync.service**    
* **/etc/systemd/system/snapraid-sync.timer**    
* **/etc/systemd/system/snapraid-scrub.service**    
* **/etc/systemd/system/snapraid-scrub.timer**    

These files do the following:

1. **snapraid-daily.service** does a sync,then a scrub (the default).    
2. **snapraid-sync.service** syncs the array only (uses the -s argument).    
3. **snapraid-scrub.service** scrubs the array only (uses the -c argument).    

If installing manually copy the above files to the
**/etc/systemd/system/** location from the cloned directory above. Note
that this is not required if installing via the debian package.

```bash
# From the earlier directory created by "git clone" do:
sudo cp ./systemd-files/snapraid-*.service /etc/systemd/system/
sudo cp ./systemd-files/snapraid-*.timer /etc/systemd/system/

# Then Reload Systemd
sudo systemctl daemon-reload
```

It's a good idea to test the service works correctly by starting the desired
one manually.
```bash
sudo systemctl start snapraid-daily.service
```

To get detailed information one can use **journalctl**.
```bash
sudo journalctl -u snapraid-daily.service --since today
```

If the service runs without issue, the next step is to enable the timers to
run the service automatically.

To enable any one of the timers do the below - enabling the services is not required,
since they are configured as oneshots and are not intended to be ran at start up. 

```bash
sudo systemctl enable snapraid-daily.timer
```

It is not recommended to edit any of the service files directly. It is instead better
to create drop-in files by using:    
```bash
sudo systemctl edit snapraid-daily.service
```

Although to get the expected results with the timer files, it might be
necessary to edit them directly.

Some further examples are provided in the docs directory for both the
main service/timer file and also drop-in files that can be used to configure
automatic restarts or systemd hardening (see below).

* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples)   
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples)

Note that some examples are also provided in the docs for using **cron**
to run the script.

* [https://github.com/zoot101/snapraid-daily/blob/main/docs/cron-examples/](https://github.com/zoot101/snapraid-daily/blob/main/docs/cron-examples/)

## Running as a Standard User with Systemd

Note that by default all of the above service files will run as root.
This is probably fine for most users, however if one wants to run
SnapRAID as a different user other than root, some further configuration
is required, namely:

* Create a directory **/etc/systemd/snapraid-.service.d/**    
* Create a file called **user.conf**, or (anything**.conf**)    
* Put the following into that file and place it in the above directory    

```bash
[Service]  
User=username   
Group=groupname
```

Where **username** and **groupname** are the user and group names of the
user one wants to run SnapRAID, and thus **SnapRAID-DAILY** as.

The naming of the **/etc/systemd/system/snapraid-.service.d/** directory
will cause it to be picked up by all of the systemd service unit files
installed by the script, or any services with a name of the structure:     
**snapraid-\[something\].service**

Lastly, reload systemd:     
```bash
sudo systemctl daemon-reload
```

As before, futher example drop-in files and unit files for systemd and some
notes are included here:

* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins)    
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins)       

# External Hooks

Since version 1.4.0, the script supports the use of an external hook when the
script starts and completes and also the use of custom notification hook if a user wishes
to use an alternative form of notifcation than standard emails. See below for Details.

Note that if any of the hooks require any variables to be passed into them (for example a service
to stop/start), that can be accomplished by doing the following
in the config file (**/etc/snapraid-daily.conf**). This is much more elegant than using
another seperate config file for the hook script. Don't forget the **"export"**!

```bash
export service1="smbd"
```

A collection of Hook scripts that integrate into the main script is provided here:

* [https://github.com/zoot101/snapraid-daily-hooks](https://github.com/zoot101/snapraid-daily-hooks)

## Notification Hook

Hook Scripts for **Apprise** and **Healthchecks.io** are provided here. Apprise is
highly recommended as its very easy to use and can send notifications to many services.
See the above link.

The Notification Hook allows the user to use an alternative form of notification with **SnapRAID-DAILY**
if desired. It can be used as an alternative to the standard email notifications
or can be used in addition to them.

A bash script is probably what is best to use here, but this hook script can be anything
that is ran from the command line and accepts the below arguments - it doesn't have to
be a bash script.

If the **SnapRAID-DAILY** script ends in success, the notification hook is called on
the command line like so:

```bash
"/path/to/notification/hook" "SnapRAID-DAILY: All OK" "/path/to/email/body"
```

The 1st argument is what would be the email subject, and the 2nd argument
is what would be the file containing the text that would form the email
body.

However, if the script ends in an error/warning, the hook script is called like so:

```bash
"/path/to/notification/hook" "SnapRAID-DAILY: Sync Warning(s)" "/path/to/email/body" "/path/to/command/log/file"
```

As before, the 1st argument is what would be the email subject, and the 2nd argument
is what would be the file containing the text that would form the email
body. The 3rd argument is the log file of the command that caused the script to exit
with an error.

To use the notification hook, set the **notification_hook** parameter in the
config file (**snapraid-daily.conf**) to the path to the hook script or executable
that will be used.

If the notification hook requires any variables to be passed into it (for example a URL
for something like ntfy or healthchecks.io), that can be accomplished by doing the following
in the config file (**/etc/snapraid-daily.conf**). This avoids requiring a new config
file for the hook script.

```bash
export ntfy_url="https://ntfy.sh/channelname"
```

Its a good idea to test the notification hook on its own before using it with
**SnapRAID-DAILY** to make sure it works as desired. To do that call it directly like
above with a test email subject and body file like so:

```bash
# Source Main Config (If Variables are Needed)
source /etc/snapraid-daily.conf

# Generate a test Email Body and Command logfile
echo "Test Email" > test_file1.txt
echo "Test Command Logfile" > test_file2.txt

# Test a Success Scenario
/path/to/notification/hook "SnapRAID-DAILY: Test Success" "test_file1.txt"

# Test an Error Scenario
/path/to/notification/hook "SnapRAID-DAILY: Test Warning" "test_file1.txt" "test_file2.txt"
```

# Start and End Hooks

The main **SnapRAID-DAILY** script can also be configured to execute a hook upon startup and also
after all sync/scrub operations have been completed. Again, these hooks can be bash
scripts, or anything that can be called from the command line.

A hook script that stops a list of services via systemd when **SnapRAID-DAILY** starts
and then re-starts them when **SnapRAID-DAILY** completes that integrates nicely into the
main script is provided here:

* [https://github.com/zoot101/snapraid-daily-hooks](https://github.com/zoot101/snapraid-daily-hooks)

A check is carried out for a non-zero (error) return code on the start hook, and the main
script will exit if this condition is encountered. This same error check on
on the end hook with however not cause **SnapRAID-DAILY** to exit, this to ensure the script
runs to end and the final notification is sent as expected.

The Start/End hooks are primarily intended to start and stop a list of services that can access files
in the **SnapRAID** array in order to allow **SnapRAID** to run without the risk of files being
modified while in use, but could be used for anything else as desired.

The start hook is executed after the main script has completed all of
its initial checks and just before it starts to run **SnapRAID**
touch/diff/sync/scrub operations. The start hook is also passed a
"start" argument, and is called like so:

```bash
/path/to/hook start
```

The end hook then is executed after all sync/scrub operations have been carried
out just before the final notification is sent. It is also executed if the
script exits due to an error condition encountered during any of the
main **SnapRAID** operations (touch/diff/sync/scrub). The end hook is
also passed an "end"argument and is called like so:

```bash
/path/to/hook end
```

The use of the "start" and "end" arguments allows the same hook to
be used at both the start and end of **SnapRAID-DAILY**. Note that
it is also possible to use different hooks at the start and end of
the script if desired.

It is also not required to use a start
**AND** end hook simultaneously, the user can use only the start 
hook or end hook as desired. The hooks also do not need to use the
"start" or "end" arguments either.

To use either of these set the **start_hook** or **end_hook** parameter in
the config file **/etc/snapraid-daily.conf** 

As before, it's good idea to test the start/end hooks on their own before using them with
**SnapRAID-DAILY** to make sure they work as desired. To do that call it directly like
below with the "start" and "end" arguments.

```bash
# If any variables are required
source /etc/snarpaid-daily.conf

# Test Start Hook
/path/to/hook start

# Test End Hook
/path/to/hook end
```

# SnapRAID Sync and Scrub Options

SnapRAID sync is invoked with the following options:   
* -c : To specify the config file for snapraid itself
* -v : Verbose Mode   
* -l : Use SnapRAID's logging function   
* -h : Read data twice during sync, as an additional safeguard against silent errors.   

SnapRAID scrub is invoked with the following options:
* -c : To specify the config file for snapraid itself
* -p : To scrub the percentage in snapraid-daily.conf
* -o : To only consider the age from snapraid-daily.conf   
* -v : Verbose Mode
* -l : Use SnapRAID's logging function 

# Detailed Operation

A detailed description of all the steps carried out by **SnapRAID-DAILY** are outlined below:

## Step 1 - Initial Checks

The script carries out an initial check of everything
before it will even attempt to interact with **SnapRAID**.

Initially the config file **snapraid-daily.conf** is read,
and its contents are checked. If anything is undefined,
a default value is assumed.

If the main config file for SnapRAID itself is not present in
the default location or doesn't exist, the script will exit.

Next checks are carried out for the script dependencies:
awk, grep, sed, mktemp, tee and SnapRAID itself. It will exit if
any of these are not present.

Next, a check on the first defined content file in the
SnapRAID config (**/etc/snapraid.conf**) is checked to
see if it exists and is writable.

This is to ensure the script is being ran as the right user,
and serves as a good sanity check to see if the content files
exist and are writable.

One could check all config files exist,  but given that there
is usually a copy on each disk, that would mean potentially
waking all the disks from standby which would be undesirable
if a sync/scrub is not ran because of a subsequent issue.

Likewise, it was decided not to check if the parity files
exist to again prevent waking the disks unless a sync or a
scrub operation are **actually** going to be carried out.

If there is an issue with not being able to access the parity
files or content files, the sync or scrub will fail and the
user will be notified anyway.

## Step 2 - Check SnapRAID Array Current Status

Checks the Array for Errors or if Touch is required using
**snapraid status**

If errors are encountered at this point, the script will exit
and send a notification email to the user. It will continue to
do this each time the script is invoked, and stop here until the
user intervenes to address whatever the error is.

If a sync was found to be in progress (this is - the last sync
was interrupted), and **\--scrub-only** is NOT specified, the
script will continue as the solution to this is usually to let
the sync complete. If **\--scrub-only** is specified, the script
will exit here.

A check is also carried out if **SnapRAID** is already in use,
ie. whether a **sync** or **scrub** etc. is currently running.
SnapRAID will not allow multiple instances of itself processing
the same array.

The script will exit in this case and the user is also notified
explicity of this.

## Step 3 - Run Start Hook If Given

After all checks are completed, and SnapRAID's status looks okay,
the start hook is called if it was specified in the config file.
If the start hook reports an error, the script will exit here and
notify the user.

## Step 4 - Run Touch if Required

If it is determined from the initial check that 1 or more files
do not have sub-zero timestamps, **snapraid touch** is ran to
add the sub-zero timestamps.

Touch of files added to the array by default will run the next
time the script is executed after the files have been added.

SnapRAID is invoked with **-v** & **-l** switches to turn on
verbose mode and logging, this is to aid in quick debugging if
errors are detected during the touch.

The output is monitored for errors and if any are detected,
the script will exit, send a notification email to the user or call
the notification hook and attach the output of the log created with
the "-l" argument to SnapRAID.

The idea here is that one can quickly know what the error is via
the notification email alone.

If it is determined that the touch operation is not required, this
step will be skipped entirely.

This step is also skipped if the **\--scrub-only** argument to the
script is used.

## Step 5 - Check Array for Changes

Runs **snapraid diff** to check the array for changes to determine
if a sync is required or not.

If no changes are detected, the script will skip the sync entirely.
If changes are detected, the sync will proceed. In the event that
the **-s, --sync-only** is used, the script will exit here if no changes
are detected.

However if either the threshold for deletions, moves or updates that are
defined in the config file **snapraid-daily.conf** are found to be
exceeded, the script will exit and notify the user via email and/or call
the notification hook if present.

The theory is that if excess deletions, moves or updates are detected, it
could very well be accidental, and a subsequent sync could prevent
the recovery of that data.

For subsequent runs, the script will continue to do this and stop
at this point until the user intervenes. This step is skipped if the
**\--scrub-only** argument is used.

## Step 6 - Run Sync to Update the Array

Runs **snapraid sync** to update the array. The start-time and finish
time are monitored to compute the duration so it can be added to the
main log.

The **-v** and **-l** switches are used to turn on verbose mode and
logging, this is to aid in quick debugging if errors are detected
during the sync operation.

The **-h** option is also used to read data a 2nd time during the sync.
This is to serve as an additional safeguard against silent errors
during what is an extreme condition for the machine whereby all
disks are spinning at the same time. See the SnapRAID documentation here for
more information:     
* https://www.snapraid.it

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and/or call the notification
hook and attach the output of the log created with the **-l** argument
to SnapRAID.

The idea here is that one can quickly know what the error is via the
notification email/other method alone.

If it is determined that the sync operation is **NOT** required from
the above Step of checking for changes, this step will be skipped
entirely.

This step is also skipped if **\--scrub-only** is active.

## Step 7 - Run Scrub to Check for Silent Corruption

Runs Scrub using the **scrub_percent** & **scrub_age** input parameters
specified in the config file **snapraid-daily.conf**. The start-time
and finish time are computed such that is can be added to the main log.

Before the scrub is carried out, the array is once again checked for
changes since the last sync so the scrub can correctly run.

In the default setup where **SnapRAID-DAILY** is called with no arguments,
this check should not find any changes since a sync was carried
out moments ago. However when one is using the **-c, --scrub-only**
option this may not be the case.

This is required as **SnapRAID** will exit with an error during a
scrub if it finds files that have been modified and not synced.

In this case, the script will exit and the user will be notified
via email explicitly that a sync is required.

The scrub is then called with the **-v** & **-l** switches to turn
on verbose mode and logging, this is to aid in quick debugging if errors
are detected during the scrub operation.

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and/or call the hook,
and attach the logfile from the output of the log created with the
**-l** argument to SnapRAID.

Once again, this is to allow for quick debugging to know exactly what the
error is from the notification email alone.

If the scrub does encounter issues such as silent corruption, the status
check at the start of the script when ran the next time will flag them,
and the script will subsequently exit each time it is invoked until the
user intervenes to attempt a manual fix.

## Step 8 - Run End Hook If Given

The end hook is now called here if it was specified in the config
file. If the end hook exits in error, the script will print a warning and
still continue so that the final notification is sent.

The end hook is also ran in the event of error conditions for
SnapRAID touch/diff/sync/scrub operations above.

## Step 9 - Send Final Notification Email

If no errors are detected during the touch, sync and scrub, or just
touch & sync, or just scrub (depending on whether the **-s, \--sync-only**
or **-c, \--scrub-only** arguments are used):

If emails are enabled, the final condensed log file for the email is sent
to the user. This will contain an concise output of all the operations carried
out and what the result was.

## Step 10 - Run Notification Hook if Given

Lastly the notification hook is called here if specified in the config file.

# Sample Output

A sample output of the script is shown below, this uses the service hook from here:

* [https://github.com/zoot101/snapraid-daily-hooks](https://github.com/zoot101/snapraid-daily-hooks)

```bash
##############################
# SnapRAID-DAILY Version: 1.4.2
##############################
Initialized at 06:00:01 on 07/07/2025
 * Hostname: server.example.org
 * Host OS: Debian GNU/Linux 13 (trixie)
 * SnapRAID Version: none
Input Options:
 * Run-Sync: YES
 * Sync Pre-Hash: YES
 * Run-Scrub: YES
 * Scrub-Percent: 15
 * Scrub-Age: 2 days and older
 * Override Thresholds: NO
 * Deletion Threshold: 1000
 * Moved Threshold: 1000
 * Updated Threshold: 1000
Hooks:
 * Start-Hook: YES
 * End-Hook: YES
 * Notification Hook: NO
Run-Log is Below:

##############################
# SnapRAID-DAILY: Initial Status Check
##############################
06:00:01 : Checking current status...
06:00:34 : No Issues Found in Initial Check
06:00:34 : Ready to run SnapRAID operations
06:00:34 : Touch Not Needed...

##############################
# SnapRAID-DAILY: Start Hook
##############################
06:00:34 : Calling Start Hook...
06:00:34 : 1 Service(s) defined in config
06:00:34 : Stopped Service 1/1: smbd
06:00:34 : Start Hook completed successfully

##############################
# SnapRAID-DAILY: Difference Check
##############################
06:00:34 : Checking array for changes...
06:01:23 : Changes Detected
 * Equal: 1578647
 * Added: 118
 * Removed: 5
 * Updated: 5
 * Moved: 0
 * Copied: 0
 * Restored: 0
06:01:23 : Proceeding to sync...

##############################
# SnapRAID-DAILY: Sync
##############################
06:01:23 : Starting Sync on 07/07/2025...
06:06:44 : Sync Completed on 07/07/2025
06:06:44 : Duration: 0 hours, 5 minutes, 21 seconds
06:06:44 : Sync was Successful
06:06:44 : Array Changes Found & Updated:
 * Added: 118
 * Removed: 5
 * Updated: 5
 * Moved: 0
 * Copied: 0
 * Restored: 0

##############################
# SnapRAID-DAILY: Scrub
##############################
06:06:44 : Checking if Array is still up to date...
06:07:17 : Array is Up-to-Date - Proceeding
06:07:17 : Starting Scrub on 07/07/2025
06:07:17 : Scrubbing 15% older than 2 days...
07:18:35 : Scrub Completed at 07/07/2025
07:18:35 : Duration: 1 hours, 11 minutes, 18 seconds
07:18:35 : Scrub was successful
07:18:35 : Scrubbed 15% older than 2 days

##############################
# SnapRAID-DAILY: End Hook
##############################
07:18:35 : Calling End Hook...
07:18:35 : 1 Service(s) defined in config
07:18:35 : Started Service 1/1: smbd
07:18:35 : End Hook completed successfully

##############################
# SnapRAID-DAILY: Array Status
##############################
07:18:35 : Current Status of the Array is as below:

SnapRAID status report:

   Files Fragmented Excess  Wasted  Used    Free  Use Name
            Files  Fragments  GB      GB      GB
  220631     180     653       -    1628     338  83% media1
  360488     595    2354       -    2100     850  71% media2
  581583     275     888       -    1534     430  78% media3
  416066    1872    6632    -2.3    2976     957  76% media4
 --------------------------------------------------------------------------
 1578768    2922   10527     0.0    8239    2577  76%


 19%|                                                        o             
    |                                                        o             
    |                                                        *            o
    |                           o                            *            *
    |              *            *              *             *            *
    |              *            *              *             *            *
    |              *            *              *             *            *
  9%|*             *            *              *             *            *
    |*             *            *  o           *             *            *
    |*             *            *  *           *             *            *
    |*             *            *  *           *             *            *
    |*             *            *  *           *             *            *
    |*             *            *  *           *             *            *
    |*             *            *  *           *             *            *
  0%|*____________o*__o__oo_____*__*_________oo*_o_**__o_____*____________*
     5                    days ago of the last scrub/sync                 0

The oldest block was scrubbed 5 days ago, the median 2, the newest 0.

No sync is in progress.
5% of the array is not scrubbed.
You have 15 files with a zero sub-second timestamp.
Run 'snapraid touch' to set their sub-second timestamps to a non-zero value.
No rehash is in progress or needed.
No error detected.

##############################
# SnapRAID-DAILY Result: SUCCESS
##############################

Regards,
server.example.org

```

# Further Examples

For examples on how to automate via systemd timers, set up a valid muttrc
config for emails, some notes on SnapRAID itself, a sample hook script, 
or notes on how to use cron instead of systemd have a look here.

* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-examples)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins](https://github.com/zoot101/snapraid-daily/tree/main/docs/systemd-drop-ins)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/snapraid-stuff](https://github.com/zoot101/snapraid-daily/tree/main/docs/snapraid-stuff)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config](https://github.com/zoot101/snapraid-daily/tree/main/docs/sample-config)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples](https://github.com/zoot101/snapraid-daily/tree/main/docs/muttrc-examples)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/cron](https://github.com/zoot101/snapraid-daily/tree/main/docs/cron)
* [https://github.com/zoot101/snapraid-daily/tree/main/docs/examples/hook-example](https://github.com/zoot101/snapraid-daily/tree/main/docs/examples/hook-example)

# Creating your own Debian Package

Given the author uses debian as their daily driver, a debian directory containing
what is required to build a debian package is included here.

While it's not necessary, if one wants to build their own debian package, they can
do the following if they are running a debian based distribution.

```bash
sudo apt install debhelper dh-exec
git clone https://github.com/zoot101/snapraid-daily
cd snapraid-daily
dpkg-buildpackage -uc -us
```

A new debian package should be created in the parent directory that can be installed
with **dpkg** or with **apt** as shown above.

# Return Codes

The Script Returns the following codes for the following conditions.
This can be useful to direct systemd or a seperate master script to
carry out further actions depending on the code. 

* 0: Success    
* 1: All Errors    
* 2: SnapRAID already in use    
* 3: Files Modified During Sync    
* 5: Thresholds Exceeded   

# Issues

Bug reports here on Github are welcome - don't hestitate if you find something wrong.

* [https://github.com/zoot101/snapraid-daily/issues](https://github.com/zoot101/snapraid-daily/issues)

# Credits

Most of the script is entirely from the author, but a lot of inspiration was
got from the following similar scripts:

Original Bash Script (from Zack Reed):

* [https://zackreed.me/snapraid-split-parity-sync-script/](https://zackreed.me/snapraid-split-parity-sync-script/)

Snapraid-Runner:

* [https://github.com/Chronial/snapraid-runner](https://github.com/Chronial/snapraid-runner)

Also a bit thank you to Andrea Mazzoleni for this excellent software:

* [https://github.com/amadvance/snapraid](https://github.com/amadvance/snapraid)     
* [https://www.snapraid.it](https://www.snapraid.it)    

Lastly - Thank you for your interest in this script. Hopefully it can be of
use to other people also.
