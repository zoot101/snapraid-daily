---
title: snapraid-daily
section: 1
header: User Manual
footer: snapraid-daily
---

# NAME

**snapraid-daily**

Bash Script for the automation of **sync** and **scrub** operations of
snapraid with in-built email notifications and monitoring of the number
of deletions.

# SYNOPSIS

snapraid-daily **\[OPTIONS...\]**

## VALID OPTIONS

**\[-s, \--sync-only\]**
:   Sync the Array Only

**\[-c, \--scrub-only\]**
:   Scrub the Array Only

**\[-o, \--override-thresholds\]**
:   Override Deletion/Moved Thresholds to force a Sync

**\[-f, \--config\] \[PATH-TO-CONFIG]**
:   Override default config file: Useful for multiple snapraid arrays

**\[-q, \--quiet\]**
:   Suppress the output of **touch, diff, sync** and **scrub** commands

**\[-h, \--help\]**
:   Print Quick Help

# DESCRIPTION

Thank you for your interest in this script. Snapraid is very good software,
but lacks any default automation or notification ability.

That is where this script comes in, it is intended to be an all-in-one
script for the automation of snapraid.

There are many other scripts out there that essentially do the same thing,
and are probably better than this one. However, none of them had exactly
the features the author wanted or were more complex than desired.

This led to this script being created by the author. It has worked quite well
for the author up to this date, and hopefully prove useful to others.

All possible scenarios were attempted to be covered. It was decided to keep
the approach simple, and only to focus on snapraid operations and simple
email notifications rather than adding many different features.

It is intended to be ran as a scheduled task via cronjob or systemd timers
(some examples are provided in the docs - see near the end of this manual
entry\), but can also easily be ran manually if need be.

If errors are detected, the user is notified by email and the script will
exit. Note that no attempts are made here to automate the correction of
errors automatically, the user will have to intervene in each case if they
are detected.

Before attempting to use this script, one should ensure that snapraid is
normally functioning. That is one can run the following commands without
any error being encountered. See **\(man snapraid\)**

1. **snapraid status**   
2. **snapraid sync**   
3. **snapraid scrub**   

The broad goal here is to be an all-in-one script to automate the necessary
snapraid functions that can be scheduled accordingly.

While the script will run out of the box with the default config, for best
operation, a config file is required.

The location for the config file **(snapraid-daily.conf)** is tried in the
following order of preference:

1. **Via the -f or \--config option if specified**    
2. **/etc/snapraid-daily.conf**    
3. **snapraid-daily.conf** in the script directory    

If the config file is not found in any of the above locations, the defaults
will be used. Note that this will disable the email functionality.

See the manual entry for the **snapraid-daily.conf** config file:
**snapraid-daily.conf\(1\)** or **$ man snapraid-daily.conf**

The contents of **snapraid-daily.conf** should contain the following and the
syntax should be correct as per bash. The script will again exit if errors
are present in this file.

1. MuttRC File Path for Notification Emails    
2. Email Address for Notification Emails    
3. Deletion Threshold    
4. Move Threshold    
5. Scrub Percentage     
6. Scrub Age     

The number of files deleted and moved are monitored and if either exceed
the threshold values specified in **snapraid-daily.conf**, the script will
exit and notify the user via email.

The idea here is that if a large number of accidental moves or deletions
are detected, it is probably an accident, and a sync would be a bad idea
as it will prevent the recovery of those files.

If errors are detected, the script will notify the user via email and attach
the logfile generated by snapraid itself, so the user can quickly see what the
problem is from the email notification alone.

By default if no arguments are invoked the script will execute the following
functions in the below order. This will accomplish everything and is
sufficient to run once a day or however often is desired.

This can also be tweaked by the supported arguments to the script if one wants
to sync the array only or scrub the array only.

Order of Operations is:

1. Check for Inital Errors    
2. Run Touch (If Required)    
3. Sync the array (If Changes are Present)    
4. Scrub the array    

# DEPENDENCIES

Dependencies are the following. The script should work on all versions of
Debian later than Bullseye (11).

Other distros with the below dependencies should work okay too, but the author
has not tested them explicitly.

1. SnapRAID - Obviously!    
2. mutt - Required for Sending the emails     
3. Valid & Working muttrc configuration     
4. awk, cut, grep and sed - For parsing the snapraid output     
5. mktemp - For creating the required **/tmp** files     
6. Bash itself of course      

# USAGE

Usage: **snapraid-daily \[OPTIONS...\]**

If ran with no options, a sync followed by a scrub will be performed.

## EXAMPLES:

To only perform sync:    
**$ snapraid-daily -s**

To only perform sync and override thresholds:     
**$ snapraid-daily -s -o**

To only perform scrub, do:     
**$ snapraid-daily -c**

To override the config file to **/path/to/user.conf** do:     
**$ snapraid-daily -f /path/to/user.conf**

If an invalid argument is specified, the script will exit.

# VALID OPTIONS

Valid **OPTIONS** are:

## -s, \--sync-only
This is useful if the user wants to seperate the sync and scrub operations.
The script will only do the following in this case:

* Check for Initial Errors     
* Touch (If Required)    
* Sync (If Changes are Present)    
* Send Notification Email     

(Scrub is skipped entirely in this case)

The subject of the final notification email is changed to **SnapRAID-Sync**
if this option is selected.

Note that **-s or \--sync-only** and **-c or \--scrub-only** can't be
active at the same time, the script will exit if they are both specified
at the same time.

## -c, \--scrub-only
This is again useful if the user wants to seperate the sync and scrub
operations. The script will only do the following in this case:

* Check for Initial Errors     
* Scrub     
* Send Notification Email     

(Touch & Sync are both skipped entirely in this case)

The subject of the final notification email is changed to
**SnapRAID-Scrub** if this option is selected.

Note that **-s or \--sync-only** and **-c or \--scrub-only** can't
be active at the same time, the script will exit if they are
both specified at the same time.

## -o, \--override-thresholds
This is for the case where excess moves or deletes are detected.
If this is specified, the script will ignore the deletion or moved number
and proceed to sync accordingly.

Note that this option has no effect if used with the
**-s, --scrub-only** option.

## -f, \--config \[PATH-TO-CONFIG\]
This is intended for the edge case where someone may have multiple
snapraid arrays on the same system.

This way one can specify a different config for the main snapraid
installation in another copy of the config file (**snapraid-daily.conf**).
Although it can be used for any other reason to override the default config.

## -q, \--quiet
Suppresses the output of the **sync,diff,sync & scrub** operations
from **snapraid**. The status printed when the script completes is
unaffected. Useful for a quieter printout, if desired.

Has no effect on email content.

## -h,  \--help
Print a Quick Help message and exit

# DETAILED OPERATION

The Steps taken are outlined below:

## STEP 1 - INITIAL CHECKS

The script carries out an initial check of everything
before it will even attempt to interact with **snapraid**.

Initially the config file **snapraid-daily.conf** is read,
and its contents are checked. If anything is undefined,
a default value is assumed. See **snapraid-daily.conf(1)**
If the main config file for snapraid itself doesn't exist,
the script will exit.

Next checks are carried out for the script dependencies:
awk, grep, sed, cut and snapraid itself. It will exit if
any of these are not present.

Next, a check on the first defined content file in the
snapraid config (**/etc/snapraid.conf**) is checked to
see if it exists and is writable.

This is to ensure the script is being ran as the right user,
and serves as a good sanity check to see if the content files
exist and are writable.

One could check all config files exist,  but given that there
is usually a copy on each disk, that would mean potentially
waking all the disks from standby which would be undesirable
if a sync/scrub is not ran because of a subsequent issue.

Likewise, it was decided not to check if the parity files
exist to again prevent waking the disks unless a sync or a
scrub **actually** are going to be carried out.

If there is an issue with not being able to access the parity
files or content files, the sync or scrub will fail and the
user will be notified anyway.

## STEP 2 - CHECK SNAPRAID ARRAY CURRENT STATUS
Checks the Array for Errors or if Touch is required using
**snapraid status**

If errors are encountered at this point, the script will exit
and send a notification email to the user. It will continue to
do this each time the script is invoked, and stop here until the
user intervenes to address whatever the error is.

If a sync was found to be in progress (this is - the last sync
was interrupted), and **\--scrub-only** is NOT specified, the
script will continue as the solution to this is usually to let
the sync complete. If **\--scrub-only** is specified, the script
will exit here.

A check is also carried out if **snapraid** is already in use,
ie. whether a **sync** or **scrub** etc. is currently running.
SnapRAID will not allow multiple instances of itself processing
the same array.

The script will exit in this case and the user is also notified
explicity via email of this.

## STEP 3 - RUN TOUCH IF REQUIRED
If it is determined from the initial check that 1 or more files
do not have sub-zero timestamps, **snapraid touch** is ran to
add the sub-zero timestamps.

Touch of files added to the array by default will run the next
time the script is executed after the files have been added.

Snapraid is invoked with **-v** & **-l** switches to turn on
verbose mode and logging, this is to aid in quick debugging if
errors are detected during the touch.

The output is monitored for errors and if any are detected,
the script will exit, send a notification email to the user and
attach the output of the log created with the "-l" switch.

The idea here is that one can quickly know what the error is via
the notification email alone.

If it is determined that the touch operation is not required, this
step will be skipped entirely.

This step is also skipped if the **\--scrub-only** argument to the
script is used.

## STEP 4 - CHECK ARRAY FOR CHANGES & EXCESS DELETIONS/MOVES
Runs **snapraid diff** to check the array for changes to determine
if a sync is required or not.

If no changes are detected, the script will skip the sync entirely.
If changes are detected, the sync will proceed. In the event that
the **-s, --sync-only** is used, the script will exit if no changes
are detected.

However if either the threshold for deletions or moves that are
defined in the config file **snapraid-daily.conf** are found to be
exceeded, the script will exit and notify the user via email.

The theory is that if excess deletions or moves are detected, it
could very well be accidental, and a subsequent sync could prevent
the recovery of that data.

For subsequent runs, the script will continue to do this and stop
at this point until the user intervenes. This step is skipped if the
**\--scrub-only** argument is used.

## STEP 5 - RUN SYNC TO UPDATE THE ARRAY
Runs **snapraid sync** to update the array. The start-time and finish
time are monitored to compute the duration so it can be added to the
email.

The **-v** & **-l** switches are used to turn on verbose mode and
logging, this is to aid in quick debugging if errors are detected
during the sync operation.

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and attach the output
of the log created with the **-l** switch to the email.

The idea here is that one can quickly know what the error is via the
notification email alone.

If it is determined that the sync operation is **NOT** required from
the above Step 4 of checking for changes, this step will be skipped
entirely.

This step is also skipped if **\--scrub-only** is active.

## STEP 6 - RUN SCRUB TO CHECK THE ARRAY FOR SILENT CORRUPTION
Runs Scrub using the **scrub_percent** & **scrub_age** input parameters
specified in the config file snapraid-daily.conf The start-time
and finish time are computed such that is can be added to the email.

Before the scrub is carried out, **Step 3** above is repeated whereby
the array is checked for changes since the last sync.

In the default setup, where the **-c, --scrub-only** option is not
used, this check should not find any changes since a sync was carried
out moments ago. Howvever when one is using the **-c, --scrub-only**
option this may not be the case.

This is required as **snapraid** will exit with an error during a
scrub if it finds files that have been modified and not synced.

In this case, the script will exit and the user will be notified
via email explicitly that a sync is required.

The scrub is then called with the **-v** & **-l** switches to turn
on verbose mode and logging, this is to aid in quick debugging if errors
are detected during the scrub operation.

The output is monitored for errors and if any are detected, the script
will exit, send a notification email to the user and attach the logfile
from the output of the log created with the **-l** switch to the email.

Once again, this is to allow for quick debugging to know exactly what the
error is from the notification email alone.

If the scrub does encounter issues such as silent corruption, the status
check at the start of the script will flag them, and the script will
subsequently exit each time it is invoked until the user intervenes to
attempt a manual fix.

## STEP 7 - SEND FINAL NOTIFICATION EMAIL
If no errors are detected during the touch, sync and scrub, or just
touch & sync, or just scrub (depending on whether the **\--sync-only**
or **\--scrub-only** arguments are used):

The final condensed log file for the email is sent to the user. This
will contain an concise output of all the operations carried out and what
the result was.

# AUTOMATION VIA SYSTEMD

By default the following systemd files are bundled with the package
installation, but are not enabled by default.

* **/etc/systemd/system/snapraid-daily.service**    
* **/etc/systemd/system/snapraid-daily.timer**    
* **/etc/systemd/system/snapraid-sync.service**    
* **/etc/systemd/system/snapraid-sync.timer**    
* **/etc/systemd/system/snapraid-scrub.service**    
* **/etc/systemd/system/snapraid-scrub.timer**    

1. **snapraid-daily** does a sync,then a scrub (the default).    
2. **snapraid-sync** syncs the array only.    
3. **snapraid-scrub** scrubs the array only.    

This is intended to cover the case where the user wishes to automate
the **sync** and **scrub** operations together, or run them seperately.

To enable any one of the timers do:     
**$ systemctl enable snapraid-daily.timer**

It is not recommended to edit any of the service files directly. It is
instead better to create drop-in files by using:     
**$ systemctl edit snapraid-daily.service**

Although to get the expected results with the timer files, it might be
necessary to edit them directly.

Some further examples are provided in the docs directory for both the
main service/timer file and also drop-in files that can be generated
(see below).    
**/usr/share/doc/snapraid-daily/systemd-examples/**

Note that some examples are also provided in the docs for using **cron**
to run the script.

## RUNNING AS A NON-ROOT USER VIA SYSTEMD

Note that by default all of the above service files will run as root.
This is probably fine for most users, however if one wants to run
snapraid as a different user other than root, some further configuration
is required, namely:

* Create a directory **/etc/systemd/snapraid-.service.d/**    
* Create a file called **user.conf**, or (anything**.conf**)    
* Put the following into that file and place it in the above directory    

**[Service]**    
**User=username**    
**Group=groupname**    

Where **username** and **groupname** are the user and group names of the
user one wants to run snapraid, and thus **snapraid-daily** as.

The naming of the **/etc/systemd/system/snapraid-.service.d/** directory
will cause it to be picked up by all of the systemd service unit files
installed by the script, or any services  with a name of the structure:     
**snapraid-\[something\].service**

Lastly, reload systemd:     
**$ systemctl daemon-reload**

Further example drop-in files and unit files for systemd and some
notes are included here:

* **/usr/share/doc/snapraid-daily/systemd-drop-ins/**     
* **/usr/share/doc/snapraid-daily/systemd-examples/**     

# EMAIL NOTIFICATIONS

A valid muttrc configuration is required to send email notifications.
A sample that works for Gmail can be found here. It should be simple to
adapt to another email provider also.    
**/usr/share/doc/snapraid-daily/muttrc-example/**

# RETURN CODES

The Script Returns the following codes for the following conditions.
This can be useful to direct systemd or a seperate master script to
carry out further actions depending on the code. It is planned to add
further return codes the future.

* 0: Success    
* 1: All Errors    
* 2: SnapRAID already in use    
* 3: Files Modified During Sync    
* 5: Thresholds Exceeded    

# AUTHOR

Mark Finnan (mfinnan101@gmail.com)

# COPYRIGHT

Copyright (C) 2021 Mark Finnan

# FURTHER EXAMPLES

For examples on how to automate via systemd timers, set up a valid muttrc
config for emails, or to use cron instead of systemd have a look here.

*  **/usr/share/doc/snapraid-daily/systemd-examples/**    
*  **/usr/share/doc/snapraid-daily/systemd-drop-ins/**    
*  **/usr/snare/doc/snapraid-daily/muttrc-example/**    
*  **/usr/share/doc/snapraid-daily/sample-config/**    
*  **/usr/share/doc/snapraid-daily/cron/**    

# SEE-ALSO

snapraid-daily.conf(1), snapraid(1), mutt(1), muttrc(5), systemd.unit(1)

